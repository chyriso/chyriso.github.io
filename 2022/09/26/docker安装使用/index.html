<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"chyriso.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":true,"nav":null,"activeClass":"changyan"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="docker安装docker安装及使用文档，请参考官方文档。 环境准备 CentOS-7-x86_64-2009 xshell 连接远程服务器 没有远程服务器，使用VMware-workstation-full-16.2.4-20089737 + CentOS-7-x86_64-DVD-2009.iso自定义安装本地服务器。  系统环境查看，内核版本3.10 以上 1234[chyris@loca"><meta property="og:type" content="article"><meta property="og:title" content="docker安装使用"><meta property="og:url" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/index.html"><meta property="og:site_name" content="Chyris"><meta property="og:description" content="docker安装docker安装及使用文档，请参考官方文档。 环境准备 CentOS-7-x86_64-2009 xshell 连接远程服务器 没有远程服务器，使用VMware-workstation-full-16.2.4-20089737 + CentOS-7-x86_64-DVD-2009.iso自定义安装本地服务器。  系统环境查看，内核版本3.10 以上 1234[chyris@loca"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E5%91%BD%E4%BB%A4.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E7%AB%AF%E5%8F%A3%E6%9A%B4%E9%9C%B2.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E7%BD%91%E7%BB%9C.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/bootfs.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/rootfs.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E5%AE%B9%E5%99%A8%E5%B1%82.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/volume.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/copy.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile00.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile01.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile02.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile03.png"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/repository.webp"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/repository02.webp"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E7%BD%91%E7%BB%9C.jpg"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E7%BD%91%E7%BB%9C02.jpg"><meta property="og:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/inet.jpg"><meta property="article:published_time" content="2022-09-26T09:00:13.000Z"><meta property="article:modified_time" content="2022-10-02T23:53:19.629Z"><meta property="article:author" content="Chyris"><meta property="article:tag" content="docker"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E5%91%BD%E4%BB%A4.png"><link rel="canonical" href="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/","path":"2022/09/26/docker安装使用/","title":"docker安装使用"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>docker安装使用 | Chyris</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Chyris" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><a target="_blank" rel="noopener" href="https://github.com/chyriso" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Chyris</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">code english</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">docker安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-%E5%AE%89%E8%A3%85%E5%92%8C%E5%8D%B8%E8%BD%BD"><span class="nav-number">1.2.</span> <span class="nav-text">docker 安装和卸载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="nav-number">2.</span> <span class="nav-text">阿里云镜像加速</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">3.</span> <span class="nav-text">docker常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-images-%E9%95%9C%E5%83%8F%E5%91%BD%E4%BB%A4"><span class="nav-number">3.1.</span> <span class="nav-text">docker images 镜像命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-search-%E6%90%9C%E7%B4%A2%E9%95%9C%E5%83%8F"><span class="nav-number">3.2.</span> <span class="nav-text">docker search 搜索镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-pull-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F"><span class="nav-number">3.3.</span> <span class="nav-text">docker pull 下载镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-rmi-%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F"><span class="nav-number">3.4.</span> <span class="nav-text">docker rmi 删除镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">4.</span> <span class="nav-text">容器命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E5%AE%B9%E5%99%A8%E5%B9%B6%E5%90%AF%E5%8A%A8"><span class="nav-number">4.1.</span> <span class="nav-text">新建容器并启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="nav-number">4.2.</span> <span class="nav-text">列出所有运行的容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E5%AE%B9%E5%99%A8"><span class="nav-number">4.3.</span> <span class="nav-text">退出容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8"><span class="nav-number">4.4.</span> <span class="nav-text">删除容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E5%92%8C%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="nav-number">4.5.</span> <span class="nav-text">停止和启动容器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%85%B6%E5%AE%83%E5%91%BD%E4%BB%A4"><span class="nav-number">5.</span> <span class="nav-text">常用其它命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="nav-number">5.1.</span> <span class="nav-text">后台启动容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="nav-number">5.2.</span> <span class="nav-text">查看日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8B-%E7%B1%BB%E4%BC%BClinux%E4%B8%AD%E7%9A%84ps%E5%91%BD%E4%BB%A4"><span class="nav-number">5.3.</span> <span class="nav-text">查看容器中的进程[类似linux中的ps命令]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E7%9A%84%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">5.4.</span> <span class="nav-text">查看镜像的元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E5%85%A5%E5%BD%93%E5%89%8D%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="nav-number">5.5.</span> <span class="nav-text">进入当前正在运行容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E5%AE%B9%E5%99%A8%E5%86%85%E6%8B%B7%E8%B4%9D%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%BB%E6%9C%BA"><span class="nav-number">5.6.</span> <span class="nav-text">从容器内拷贝文件到主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E5%B0%8F%E7%BB%93"><span class="nav-number">5.7.</span> <span class="nav-text">命令小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker%E5%91%BD%E4%BB%A4%E7%BB%83%E4%B9%A0"><span class="nav-number">6.</span> <span class="nav-text">docker命令练习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2nginx"><span class="nav-number">6.1.</span> <span class="nav-text">部署nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2tomcat"><span class="nav-number">6.2.</span> <span class="nav-text">部署tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2es-Kibana"><span class="nav-number">6.3.</span> <span class="nav-text">部署es+Kibana</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">可视化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#portainer"><span class="nav-number">7.1.</span> <span class="nav-text">portainer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rancher-CI-x2F-CD"><span class="nav-number">7.2.</span> <span class="nav-text">Rancher(CI&#x2F;CD)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker%E9%95%9C%E5%83%8F"><span class="nav-number">8.</span> <span class="nav-text">Docker镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%95%9C%E5%83%8F"><span class="nav-number">8.1.</span> <span class="nav-text">什么是镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker%E9%95%9C%E5%83%8F%E8%8E%B7%E5%8F%96"><span class="nav-number">8.2.</span> <span class="nav-text">docker镜像获取</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-pull"><span class="nav-number">8.2.1.</span> <span class="nav-text">docker pull</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-build"><span class="nav-number">8.2.2.</span> <span class="nav-text">docker build</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-load"><span class="nav-number">8.2.3.</span> <span class="nav-text">docker load</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-commit"><span class="nav-number">8.2.4.</span> <span class="nav-text">docker commit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-import"><span class="nav-number">8.2.5.</span> <span class="nav-text">docker import</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-%E9%95%9C%E5%83%8F%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86"><span class="nav-number">8.3.</span> <span class="nav-text">Docker 镜像加载原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#UnionFS%EF%BC%88%E8%81%94%E5%90%88%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%89"><span class="nav-number">8.3.1.</span> <span class="nav-text">UnionFS（联合文件系统）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bootfs%E5%92%8Crootfs"><span class="nav-number">8.3.2.</span> <span class="nav-text">bootfs和rootfs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82"><span class="nav-number">8.3.3.</span> <span class="nav-text">镜像分层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%B1%82"><span class="nav-number">8.3.4.</span> <span class="nav-text">容器层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#commit%E9%95%9C%E5%83%8F"><span class="nav-number">8.3.5.</span> <span class="nav-text">commit镜像</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="nav-number">9.</span> <span class="nav-text">容器数据卷</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="nav-number">9.1.</span> <span class="nav-text">什么是容器数据卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="nav-number">9.2.</span> <span class="nav-text">使用数据卷</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E6%8C%82%E8%BD%BD"><span class="nav-number">9.2.1.</span> <span class="nav-text">直接使用命令挂载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MySql%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">9.2.2.</span> <span class="nav-text">MySql容器数据持久化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E5%90%8D%E5%92%8C%E5%8C%BF%E5%90%8D%E6%8C%82%E8%BD%BD"><span class="nav-number">9.3.</span> <span class="nav-text">具名和匿名挂载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E8%AF%86-Dockerfile"><span class="nav-number">9.4.</span> <span class="nav-text">初识 Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8"><span class="nav-number">9.5.</span> <span class="nav-text">数据卷容器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-number">9.5.1.</span> <span class="nav-text">容器间同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql-%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB"><span class="nav-number">9.5.2.</span> <span class="nav-text">mysql 数据共享</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">9.5.3.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dockerfile"><span class="nav-number">10.</span> <span class="nav-text">Dockerfile</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-%E4%BB%8B%E7%BB%8D"><span class="nav-number">10.1.</span> <span class="nav-text">Dockerfile 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">10.2.</span> <span class="nav-text">Dockerfile 构建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">10.2.1.</span> <span class="nav-text">内容基础知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8CDockerFile%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">10.2.2.</span> <span class="nav-text">执行DockerFile大致流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">10.2.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DockerFile%E6%8C%87%E4%BB%A4"><span class="nav-number">10.3.</span> <span class="nav-text">DockerFile指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E6%8C%87%E4%BB%A4"><span class="nav-number">10.3.1.</span> <span class="nav-text">所有指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMD%E5%92%8CENTRYPOINT"><span class="nav-number">10.3.2.</span> <span class="nav-text">CMD和ENTRYPOINT</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89centos%E9%95%9C%E5%83%8F"><span class="nav-number">10.4.</span> <span class="nav-text">自定义centos镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E9%95%9C%E5%83%8F"><span class="nav-number">10.5.</span> <span class="nav-text">自定义tomcat镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E9%95%9C%E5%83%8F"><span class="nav-number">10.6.</span> <span class="nav-text">发布镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E5%88%B0DockerHub"><span class="nav-number">10.6.1.</span> <span class="nav-text">发布到DockerHub</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91"><span class="nav-number">10.6.2.</span> <span class="nav-text">发布到阿里云</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-number">10.7.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E7%BD%91%E7%BB%9C"><span class="nav-number">11.</span> <span class="nav-text">Docker 网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%90%86%E8%A7%A3-docker0"><span class="nav-number">11.1.</span> <span class="nav-text">理解 docker0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">11.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#link"><span class="nav-number">11.3.</span> <span class="nav-text">--link</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="nav-number">11.4.</span> <span class="nav-text">自定义网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A"><span class="nav-number">11.5.</span> <span class="nav-text">网络连通</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Redis%E9%9B%86%E7%BE%A4"><span class="nav-number">12.</span> <span class="nav-text">部署Redis集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%89%93%E5%8C%85%E6%88%90docker%E9%95%9C%E5%83%8F"><span class="nav-number">13.</span> <span class="nav-text">SpringBoot微服务打包成docker镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">14.</span> <span class="nav-text">References</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Chyris" src="/images/R-C2.jpg"><p class="site-author-name" itemprop="name">Chyris</p><div class="site-description" itemprop="description">The rain fell, on my body</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/chyriso" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chyriso" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://gitee.com/chyris" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;chyris" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>Gitee</a> </span><span class="links-of-author-item"><a href="mailto:927246474@qq.com" title="E-Mail → mailto:927246474@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://stackoverflow.com/yourname" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com&#x2F;" rel="noopener" target="_blank">liaoxuefeng.com</a></li><li class="links-of-blogroll-item"><a href="https://wiki.jikexueyuan.com/" title="https:&#x2F;&#x2F;wiki.jikexueyuan.com&#x2F;" rel="noopener" target="_blank">wiki.jikexueyuan</a></li><li class="links-of-blogroll-item"><a href="https://leetcode.cn/" title="https:&#x2F;&#x2F;leetcode.cn&#x2F;" rel="noopener" target="_blank">leetcode.cn</a></li><li class="links-of-blogroll-item"><a href="https://www.bilibili.com/" title="https:&#x2F;&#x2F;www.bilibili.com&#x2F;" rel="noopener" target="_blank">bilibili.com</a></li></ul></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/R-C2.jpg"><meta itemprop="name" content="Chyris"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Chyris"><meta itemprop="description" content="The rain fell, on my body"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="docker安装使用 | Chyris"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">docker安装使用</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-09-26 17:00:13" itemprop="dateCreated datePublished" datetime="2022-09-26T17:00:13+08:00">2022-09-26</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2022-10-03 07:53:19" itemprop="dateModified" datetime="2022-10-03T07:53:19+08:00">2022-10-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/major/" itemprop="url" rel="index"><span itemprop="name">major</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/major/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/major/programming/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a> </span></span><span class="post-meta-item" title="Views" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Comments: </span><a title="docker安装使用" href="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/#SOHUCS" itemprop="discussionUrl"><span id="sourceId::ca091de384390f79d61fa4bd6a95c233" class="cy_cmt_count" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>16k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>15 mins.</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h2><p>docker安装及使用文档，请参考<a target="_blank" rel="noopener" href="https://docs.docker.com/">官方文档</a>。</p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li>CentOS-7-x86_64-2009</li><li>xshell 连接远程服务器</li><li>没有远程服务器，使用<code>VMware-workstation-full-16.2.4-20089737 + CentOS-7-x86_64-DVD-2009.iso</code>自定义安装本地服务器。</li></ul><p>系统环境查看，内核版本3.10 以上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ pwd</span><br><span class="line">/home/chyris</span><br><span class="line">[chyris@localhost ~]$ uname -r</span><br><span class="line">3.10.0-1160.el7.x86_64</span><br></pre></td></tr></table></figure><p>查看系统版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ cat /etc/os-release</span><br><span class="line">NAME=&quot;CentOS Linux&quot;</span><br><span class="line">VERSION=&quot;7 (Core)&quot;</span><br><span class="line">ID=&quot;centos&quot;</span><br><span class="line">ID_LIKE=&quot;rhel fedora&quot;</span><br><span class="line">VERSION_ID=&quot;7&quot;</span><br><span class="line">PRETTY_NAME=&quot;CentOS Linux 7 (Core)&quot;</span><br><span class="line">ANSI_COLOR=&quot;0;31&quot;</span><br><span class="line">CPE_NAME=&quot;cpe:/o:centos:centos:7&quot;</span><br><span class="line">HOME_URL=&quot;https://www.centos.org/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.centos.org/&quot;</span><br><span class="line"></span><br><span class="line">CENTOS_MANTISBT_PROJECT=&quot;CentOS-7&quot;</span><br><span class="line">CENTOS_MANTISBT_PROJECT_VERSION=&quot;7&quot;</span><br><span class="line">REDHAT_SUPPORT_PRODUCT=&quot;centos&quot;</span><br><span class="line">REDHAT_SUPPORT_PRODUCT_VERSION=&quot;7&quot;</span><br></pre></td></tr></table></figure><p>以上环境准备没有问题，可以开始安装docker。</p><h3 id="docker-安装和卸载"><a href="#docker-安装和卸载" class="headerlink" title="docker 安装和卸载"></a>docker 安装和卸载</h3><p>参考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/">官方文档</a></p><p>卸载旧的版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$  sudo yum remove docker \</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">                  docker-client \</span></span><br><span class="line"><span class="language-bash">&gt;                   docker-client-latest \</span></span><br><span class="line"><span class="language-bash">&gt;                   docker-common \</span></span><br><span class="line"><span class="language-bash">&gt;                   docker-latest \</span></span><br><span class="line"><span class="language-bash">&gt;                   docker-latest-logrotate \</span></span><br><span class="line"><span class="language-bash">&gt;                   docker-logrotate \</span></span><br><span class="line"><span class="language-bash">&gt;                   docker-engine</span></span><br><span class="line"></span><br><span class="line">我们信任您已经从系统管理员那里了解了日常注意事项。</span><br><span class="line">总结起来无外乎这三点：</span><br><span class="line"></span><br><span class="line">    #1) 尊重别人的隐私。</span><br><span class="line">    #2) 输入前要先考虑(后果和风险)。</span><br><span class="line">    #3) 权力越大，责任越大。</span><br><span class="line"></span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">参数 docker 没有匹配</span><br><span class="line">参数 docker-client 没有匹配</span><br><span class="line">参数 docker-client-latest 没有匹配</span><br><span class="line">参数 docker-common 没有匹配</span><br><span class="line">参数 docker-latest 没有匹配</span><br><span class="line">参数 docker-latest-logrotate 没有匹配</span><br><span class="line">参数 docker-logrotate 没有匹配</span><br><span class="line">参数 docker-engine 没有匹配</span><br><span class="line">不删除任何软件包</span><br></pre></td></tr></table></figure><p>由于之前没有安装过docker，所以这里不删除任何软件包。</p><p>安装需要的安装包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo yum install -y yum-utils</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirror.lzu.edu.cn</span><br><span class="line"> * extras: mirror.lzu.edu.cn</span><br><span class="line"> * updates: mirrors.bupt.edu.cn</span><br><span class="line">软件包 yum-utils-1.1.31-54.el7_8.noarch 已安装并且是最新版本</span><br><span class="line">无须任何处理</span><br></pre></td></tr></table></figure><p>设置镜像仓库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p>由于默认使用国外的镜像源十很慢，因此设置使用国内镜像地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p>出现以下内容阿里云镜像设置成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo yum-config-manager \</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    --add-repo \</span></span><br><span class="line"><span class="language-bash">&gt;     http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">adding repo from: http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">grabbing file http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">repo saved to /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure><p>更新yum软件包索引</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><p>安装docker引擎</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><p>上述操作将安装最新版的 Docker Engine, containerd, 和 Docker Compose</p><p>如果你不想安装最新版本的docker，可以指定版本安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line">sudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><p>安装完成之后，启动docker，并查看docker信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line">docker version</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo systemctl start docker</span><br><span class="line">[chyris@localhost ~]$ sudo docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           20.10.18</span><br><span class="line"> API version:       1.41</span><br><span class="line"> Go version:        go1.18.6</span><br><span class="line"> Git commit:        b40c2f6</span><br><span class="line"> Built:             Thu Sep  8 23:14:08 2022</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      true</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          20.10.18</span><br><span class="line">  API version:      1.41 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.18.6</span><br><span class="line">  Git commit:       e42327a</span><br><span class="line">  Built:            Thu Sep  8 23:12:21 2022</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.6.8</span><br><span class="line">  GitCommit:        9cd3357b7fd7218e4aec3eae239db1f68a5a6ec6</span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.1.4</span><br><span class="line">  GitCommit:        v1.1.4-0-g5fd4c4d</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.19.0</span><br><span class="line">  GitCommit:        de40ad0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>启动hello-world</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run hello-world</span><br><span class="line">Unable to find image &#x27;hello-world:latest&#x27; locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">2db29710123e: Pull complete </span><br><span class="line">Digest: sha256:62af9efd515a25f84961b70f973a798d2eca956b1b2b026d0a4a63a3b0b6a3f2</span><br><span class="line">Status: Downloaded newer image for hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image which runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"><span class="meta prompt_"> $ </span><span class="language-bash">docker run -it ubuntu bash</span></span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查看镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker images</span><br></pre></td></tr></table></figure><p>执行docker run 镜像 时，本地没有就去仓库pull一个镜像放到本地仓库。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker images</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">hello-world   latest    feb5d9fea6a5   12 months ago   13.3kB</span><br></pre></td></tr></table></figure><p>卸载docker分为两步</p><p>卸载依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><p>删除资源<br>Images, containers, volumes, or customized configuration files on your host are not automatically removed. To delete all images, containers, and volumes:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf /var/lib/docker</span><br><span class="line">sudo rm -rf /var/lib/containerd</span><br></pre></td></tr></table></figure><p>&#x2F;var&#x2F;lib&#x2F;docker，docker的默认工作路径。</p><h2 id="阿里云镜像加速"><a href="#阿里云镜像加速" class="headerlink" title="阿里云镜像加速"></a>阿里云镜像加速</h2><p>注册并登录<a target="_blank" rel="noopener" href="https://www.aliyun.com/?utm_content=se_1008364713">阿里云</a>账号，进入控制台，在弹性计算中找到容器镜像服务，就可以看到centos的镜像加速器地址以及配置方法。</p><p>配置镜像加速器，通过修改daemon配置文件&#x2F;etc&#x2F;docker&#x2F;daemon.json来使用加速器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://xxxxx.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="docker常用命令"><a href="#docker常用命令" class="headerlink" title="docker常用命令"></a>docker常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version      # 显示版本信息</span><br><span class="line">docker info         # 显示docker的系统信息，包括镜像和容器</span><br><span class="line">docker 命令 --help  # 帮助命令</span><br></pre></td></tr></table></figure><p>查看官方<a target="_blank" rel="noopener" href="https://docs.docker.com/reference/">帮助文档</a></p><h3 id="docker-images-镜像命令"><a href="#docker-images-镜像命令" class="headerlink" title="docker images 镜像命令"></a>docker images 镜像命令</h3><p>查看所有本地主机上的镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker images</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">hello-world   latest    feb5d9fea6a5   12 months ago   13.3kB</span><br></pre></td></tr></table></figure><p>REPOSITORY 镜像仓库源<br>TAG 镜像标签<br>IMAGE ID 镜像的id<br>CREATED 镜像的创建时间<br>SIZE 镜像的大小</p><p>查看可选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker images --help</span><br><span class="line"></span><br><span class="line">Usage:  docker images [OPTIONS] [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">List images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all             Show all images (default hides intermediate images)</span><br><span class="line">      --digests         Show digests</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided</span><br><span class="line">      --format string   Pretty-print images using a Go template</span><br><span class="line">      --no-trunc        Don&#x27;t truncate output</span><br><span class="line">  -q, --quiet           Only show image IDs</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="docker-search-搜索镜像"><a href="#docker-search-搜索镜像" class="headerlink" title="docker search 搜索镜像"></a>docker search 搜索镜像</h3><p>在<a target="_blank" rel="noopener" href="https://hub.docker.com/">hub.docker</a>可以手动搜索镜像并提示操作，这里使用search命令搜索。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search nginx</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker search nginx</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">NAME                                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">nginx                                             Official build of Nginx.                        17444     [OK]       </span><br><span class="line">linuxserver/nginx                                 An Nginx container, brought to you by LinuxS…   178                  </span><br><span class="line">bitnami/nginx                                     Bitnami nginx Docker Image                      140                  [OK]</span><br><span class="line">ubuntu/nginx                                      Nginx, a high-performance reverse proxy &amp; we…   61                   </span><br><span class="line">bitnami/nginx-ingress-controller                  Bitnami Docker Image for NGINX Ingress Contr…   20                   [OK]</span><br><span class="line">rancher/nginx-ingress-controller                                                                  11                   </span><br><span class="line">webdevops/nginx                                   Nginx container                                 10                   [OK]</span><br><span class="line">ibmcom/nginx-ingress-controller                   Docker Image for IBM Cloud Private-CE (Commu…   4                    </span><br><span class="line">bitnami/nginx-ldap-auth-daemon                                                                    3                    </span><br><span class="line">rancher/nginx                                                                                     2                    </span><br><span class="line">kasmweb/nginx                                     An Nginx image based off nginx:alpine and in…   2                    </span><br><span class="line">vmware/nginx                                                                                      2                    </span><br><span class="line">rancher/nginx-ingress-controller-defaultbackend                                                   2                   </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker search --help</span><br><span class="line"></span><br><span class="line">Usage:  docker search [OPTIONS] TERM</span><br><span class="line"></span><br><span class="line">Search the Docker Hub for images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided</span><br><span class="line">      --format string   Pretty-print search using a Go template</span><br><span class="line">      --limit int       Max number of search results (default 25)</span><br><span class="line">      --no-trunc        Don&#x27;t truncate output</span><br></pre></td></tr></table></figure><p>搜索出stars&gt;100的所有镜像(收藏数大于100)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker search nginx --filter=STARS=100</span><br><span class="line">NAME                DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">nginx               Official build of Nginx.                        17444     [OK]       </span><br><span class="line">linuxserver/nginx   An Nginx container, brought to you by LinuxS…   178                  </span><br><span class="line">bitnami/nginx       Bitnami nginx Docker Image                      140                  [OK]</span><br></pre></td></tr></table></figure><h3 id="docker-pull-下载镜像"><a href="#docker-pull-下载镜像" class="headerlink" title="docker pull 下载镜像"></a>docker pull 下载镜像</h3><p>查看命令帮助</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker pull --help</span><br><span class="line"></span><br><span class="line">Usage:  docker pull [OPTIONS] NAME[:TAG|@DIGEST]</span><br><span class="line"></span><br><span class="line">Pull an image or a repository from a registry</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --all-tags                Download all tagged images in the repository</span><br><span class="line">      --disable-content-trust   Skip image verification (default true)</span><br><span class="line">      --platform string         Set platform if server is multi-platform capable</span><br><span class="line">  -q, --quiet                   Suppress verbose output</span><br></pre></td></tr></table></figure><p>下载镜像 docker pull 镜像名[:tag]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker pull mysql</span><br><span class="line">Using default tag: latest   # 不写tag，默认就是下载latest最新版镜像</span><br><span class="line">latest: Pulling from library/mysql</span><br><span class="line">72a69066d2fe: Pull complete # 分层下载，docker image的核心 联合文件系统</span><br><span class="line">93619dbc5b36: Pull complete </span><br><span class="line">99da31dd6142: Pull complete </span><br><span class="line">626033c43d70: Pull complete </span><br><span class="line">37d5d7efb64e: Pull complete </span><br><span class="line">ac563158d721: Pull complete </span><br><span class="line">d2ba16033dad: Pull complete </span><br><span class="line">688ba7d5c01a: Pull complete </span><br><span class="line">00e060b6d11d: Pull complete </span><br><span class="line">1c04857f594f: Pull complete </span><br><span class="line">4d7cfa90e6ea: Pull complete </span><br><span class="line">e0431212d27d: Pull complete </span><br><span class="line">Digest: sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709 # 签名防伪标志</span><br><span class="line">Status: Downloaded newer image for mysql:latest</span><br><span class="line">docker.io/library/mysql:latest  # 真实地址</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以下两个命令等价：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br><span class="line">docker pull docker.io/library/mysql:latest  # 真实地址</span><br></pre></td></tr></table></figure><p>指定版本下载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull mysql:5.7</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker pull mysql:5.7</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line">72a69066d2fe: Already exists </span><br><span class="line">93619dbc5b36: Already exists </span><br><span class="line">99da31dd6142: Already exists </span><br><span class="line">626033c43d70: Already exists </span><br><span class="line">37d5d7efb64e: Already exists </span><br><span class="line">ac563158d721: Already exists </span><br><span class="line">d2ba16033dad: Already exists </span><br><span class="line">0ceb82207cd7: Pull complete </span><br><span class="line">37f2405cae96: Pull complete </span><br><span class="line">e2482e017e53: Pull complete </span><br><span class="line">70deed891d42: Pull complete </span><br><span class="line">Digest: sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Status: Downloaded newer image for mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7</span><br></pre></td></tr></table></figure><p>Already exists: 在联合文件系统中的与mysql:lasted下载时公用的层级，5.7版本下载时直接加载即可，无需主动下载，而下面的层级存在差异，因此需要重新下载。</p><p>全部下载完成，此时即可查看所有镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mysql         5.7       c20987f18b13   9 months ago    448MB</span><br><span class="line">mysql         latest    3218b38490ce   9 months ago    516MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   12 months ago   13.3kB</span><br></pre></td></tr></table></figure><h3 id="docker-rmi-删除镜像"><a href="#docker-rmi-删除镜像" class="headerlink" title="docker rmi 删除镜像"></a>docker rmi 删除镜像</h3><p>查看命令帮助</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker rmi --help</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line"></span><br><span class="line">Usage:  docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"></span><br><span class="line">Remove one or more images</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --force      Force removal of the image</span><br><span class="line">      --no-prune   Do not delete untagged parents</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>删除指定镜像：<code>sudo docker rmi -f 镜像id</code></p><p>删除多个镜像：<code>sudo docker rmi -f 镜像id 镜像id 镜像id</code></p><p>删除全部镜像：<code>sudo docker rmi -f $(sudo docker images -aq)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rmi -f c20987f18b13</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker images -a</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mysql         5.7       c20987f18b13   9 months ago    448MB</span><br><span class="line">mysql         latest    3218b38490ce   9 months ago    516MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   12 months ago   13.3kB</span><br><span class="line">[chyris@localhost ~]$ ^C</span><br><span class="line">[chyris@localhost ~]$ sudo docker rmi -f c20987f18b13</span><br><span class="line">Untagged: mysql:5.7</span><br><span class="line">Untagged: mysql@sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Deleted: sha256:c20987f18b130f9d144c9828df630417e2a9523148930dc3963e9d0dab302a76</span><br><span class="line">Deleted: sha256:6567396b065ee734fb2dbb80c8923324a778426dfd01969f091f1ab2d52c7989</span><br><span class="line">Deleted: sha256:0910f12649d514b471f1583a16f672ab67e3d29d9833a15dc2df50dd5536e40f</span><br><span class="line">Deleted: sha256:6682af2fb40555c448b84711c7302d0f86fc716bbe9c7dc7dbd739ef9d757150</span><br><span class="line">Deleted: sha256:5c062c3ac20f576d24454e74781511a5f96739f289edaadf2de934d06e910b92</span><br><span class="line">[chyris@localhost ~]$ sudo docker images -a</span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mysql         latest    3218b38490ce   9 months ago    516MB</span><br><span class="line">hello-world   latest    feb5d9fea6a5   12 months ago   13.3kB</span><br><span class="line">[chyris@localhost ~]$ sudo docker rmi -f $(sudo docker images -aq)</span><br><span class="line">Untagged: mysql:latest</span><br><span class="line">Untagged: mysql@sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709</span><br><span class="line">Deleted: sha256:3218b38490cec8d31976a40b92e09d61377359eab878db49f025e5d464367f3b</span><br><span class="line">Deleted: sha256:aa81ca46575069829fe1b3c654d9e8feb43b4373932159fe2cad1ac13524a2f5</span><br><span class="line">Deleted: sha256:0558823b9fbe967ea6d7174999be3cc9250b3423036370dc1a6888168cbd224d</span><br><span class="line">Deleted: sha256:a46013db1d31231a0e1bac7eeda5ad4786dea0b1773927b45f92ea352a6d7ff9</span><br><span class="line">Deleted: sha256:af161a47bb22852e9e3caf39f1dcd590b64bb8fae54315f9c2e7dc35b025e4e3</span><br><span class="line">Deleted: sha256:feff1495e6982a7e91edc59b96ea74fd80e03674d92c7ec8a502b417268822ff</span><br><span class="line">Deleted: sha256:8805862fcb6ef9deb32d4218e9e6377f35fb351a8be7abafdf1da358b2b287ba</span><br><span class="line">Deleted: sha256:872d2f24c4c64a6795e86958fde075a273c35c82815f0a5025cce41edfef50c7</span><br><span class="line">Deleted: sha256:6fdb3143b79e1be7181d32748dd9d4a845056dfe16ee4c827410e0edef5ad3da</span><br><span class="line">Deleted: sha256:b0527c827c82a8f8f37f706fcb86c420819bb7d707a8de7b664b9ca491c96838</span><br><span class="line">Deleted: sha256:75147f61f29796d6528486d8b1f9fb5d122709ea35620f8ffcea0e0ad2ab0cd0</span><br><span class="line">Deleted: sha256:2938c71ddf01643685879bf182b626f0a53b1356138ef73c40496182e84548aa</span><br><span class="line">Deleted: sha256:ad6b69b549193f81b039a1d478bc896f6e460c77c1849a4374ab95f9a3d2cea2</span><br><span class="line">Untagged: hello-world:latest</span><br><span class="line">Untagged: hello-world@sha256:62af9efd515a25f84961b70f973a798d2eca956b1b2b026d0a4a63a3b0b6a3f2</span><br><span class="line">Deleted: sha256:feb5d9fea6a5e9606aa995e879d862b825965ba48de054caab5ef356dc6b3412</span><br><span class="line">[chyris@localhost ~]$ sudo docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h2><p>使用docker run一个镜像，即可创建一个容器</p><p>下载一个最新版本的centos</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull centos</span><br></pre></td></tr></table></figure><h3 id="新建容器并启动"><a href="#新建容器并启动" class="headerlink" title="新建容器并启动"></a>新建容器并启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run [可选参数] image</span><br></pre></td></tr></table></figure><p>查看docker run 参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --help</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li>–name&#x3D;”name” 创建容器时命名</li><li>-d 后台方式运行，nohup</li><li>-it 使用交互方式运行，进入容器查看内容</li><li>-p 指定容器端口 -p 8080:8080<ul><li>-ip:主机端口：容器端口</li><li>-p 主机端口：容器端口</li><li>-p 容器端口 不往外走</li><li>容器端口</li></ul></li><li>-P 随机指定端口</li></ul><p>启动并进入容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -it centos /bin/bash</span><br><span class="line">[root@239ce122ad01 /]# </span><br></pre></td></tr></table></figure><p>查看容器内的centos</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -it centos /bin/bash</span><br><span class="line">[root@239ce122ad01 /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@239ce122ad01 /]# </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从容器退回主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@239ce122ad01 /]# exit</span><br><span class="line">exit</span><br><span class="line">[chyris@localhost ~]$ </span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="列出所有运行的容器"><a href="#列出所有运行的容器" class="headerlink" title="列出所有运行的容器"></a>列出所有运行的容器</h3><p>docker ps 命令</p><p><code>docker ps</code> 列出当前正在运行的容器</p><p><code>docker ps -a</code> 列出当前正在运行的容器+历史运行过的容器</p><p><code>docker ps -n=?</code> 显示最近创建的容器</p><p><code>docker ps -a -n=?</code> 显示最近创建的容器</p><p><code>docker ps -q</code> 只显示容器的编号</p><p><code>docker ps -aq</code> 显示所有容器的编号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND       CREATED         STATUS                     PORTS     NAMES</span><br><span class="line">239ce122ad01   centos         &quot;/bin/bash&quot;   8 minutes ago   Exited (0) 4 minutes ago             keen_pascal</span><br><span class="line">1abb8920fce6   feb5d9fea6a5   &quot;/hello&quot;      3 hours ago     Exited (0) 3 hours ago               angry_kalam</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps -a -n=2</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND       CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">239ce122ad01   centos         &quot;/bin/bash&quot;   22 minutes ago   Exited (0) 18 minutes ago             keen_pascal</span><br><span class="line">1abb8920fce6   feb5d9fea6a5   &quot;/hello&quot;      4 hours ago      Exited (0) 4 hours ago                angry_kalam</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps -a -n=1</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">239ce122ad01   centos    &quot;/bin/bash&quot;   22 minutes ago   Exited (0) 18 minutes ago             keen_pascal</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps -n=1</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">239ce122ad01   centos    &quot;/bin/bash&quot;   22 minutes ago   Exited (0) 18 minutes ago             keen_pascal</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps -aq</span><br><span class="line">239ce122ad01</span><br><span class="line">1abb8920fce6</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="退出容器"><a href="#退出容器" class="headerlink" title="退出容器"></a>退出容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit 直接停止容器并退出</span><br><span class="line">Ctrl + P + Q 容器不停止退出</span><br></pre></td></tr></table></figure><p>进入容器后执行 <code>Ctrl + P + Q</code> ，即可退出容器而不停止</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">[chyris@localhost ~]$ sudo docker run -it centos /bin/bash</span><br><span class="line">[root@79e553547440 /]# [chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS     NAMES</span><br><span class="line">79e553547440   centos    &quot;/bin/bash&quot;   46 seconds ago   Up 45 seconds             xenodochial_banzai</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><p>删除指定容器，不能删除正在运行的容器，如果要强制删除<code>sudo docker rm -f 容器id</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm 容器id</span><br></pre></td></tr></table></figure><p>删除所有容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm -f $(docker ps -aq)</span><br></pre></td></tr></table></figure><p>删除所有容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a -q|xargs docker rm</span><br></pre></td></tr></table></figure><h3 id="停止和启动容器"><a href="#停止和启动容器" class="headerlink" title="停止和启动容器"></a>停止和启动容器</h3><p>启动一个容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker start 容器id</span><br></pre></td></tr></table></figure><p>重启一个容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker restart 容器id</span><br></pre></td></tr></table></figure><p>停止一个正在运行的容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop 容器id</span><br></pre></td></tr></table></figure><p>强制停止一个容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker kill 容器id</span><br></pre></td></tr></table></figure><h2 id="常用其它命令"><a href="#常用其它命令" class="headerlink" title="常用其它命令"></a>常用其它命令</h2><h3 id="后台启动容器"><a href="#后台启动容器" class="headerlink" title="后台启动容器"></a>后台启动容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d centos</span><br><span class="line">e3cd4778bdf6bf56b1e70dd5f5900280a5e5347bd6993657ea75751292007cba</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></pre></td></tr></table></figure><p>后台启动容器后，centos停止了：容器使用后台运行，必须要一个前台进程。docker发现没有应用，就会自动停止。</p><h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><p>查看帮助</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker logs --help</span><br><span class="line"></span><br><span class="line">Usage:  docker logs [OPTIONS] CONTAINER</span><br><span class="line"></span><br><span class="line">Fetch the logs of a container</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --details        Show extra details provided to logs</span><br><span class="line">  -f, --follow         Follow log output</span><br><span class="line">      --since string   Show logs since timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m for 42 minutes)</span><br><span class="line">  -n, --tail string    Number of lines to show from the end of the logs (default &quot;all&quot;)</span><br><span class="line">  -t, --timestamps     Show timestamps</span><br><span class="line">      --until string   Show logs before a timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m for 42 minutes)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查看并无日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker logs -f -t --tail number 容器id</span><br></pre></td></tr></table></figure><p>编写shell脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d centos /bin/bash -c &quot;while true;do echo xxx;sleep 2;done&quot;</span><br></pre></td></tr></table></figure><p><code>-tf</code> 显示日志<br><code>-f</code> follow output,实时追踪<br><code>-t</code> 日志显示时间戳<br><code>-- tail number</code> 要显示日志条数</p><p>shell运行脚本的两种方法：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash xx.sh</span><br><span class="line">bash -c &quot;cmd string&quot;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">[chyris@localhost ~]$ sudo docker run -d centos /bin/bash -c &quot;while true;do echo xxx;sleep 2;done&quot;</span><br><span class="line">72fa3d3ba58022654e8dcb215c71364c0a5addb69cc5850608a54bf9dabf6b6c</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS        PORTS     NAMES</span><br><span class="line">72fa3d3ba580   centos    &quot;/bin/bash -c &#x27;while…&quot;   2 seconds ago   Up 1 second             vigilant_brown</span><br><span class="line">[chyris@localhost ~]$ sudo docker logs -f -t --tail 10 72fa3d3ba580</span><br><span class="line">2022-09-26T18:03:31.634395615Z xxx</span><br><span class="line">2022-09-26T18:03:33.636541123Z xxx</span><br><span class="line">2022-09-26T18:03:35.639232025Z xxx</span><br><span class="line">2022-09-26T18:03:37.641563794Z xxx</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="查看容器中的进程-类似linux中的ps命令"><a href="#查看容器中的进程-类似linux中的ps命令" class="headerlink" title="查看容器中的进程[类似linux中的ps命令]"></a>查看容器中的进程[类似linux中的ps命令]</h3><p>查看top命令帮助</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker top --help</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line"></span><br><span class="line">Usage:  docker top CONTAINER [ps OPTIONS]</span><br><span class="line"></span><br><span class="line">Display the running processes of a container</span><br></pre></td></tr></table></figure><p>查看容器内进程信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker top 容器id</span><br></pre></td></tr></table></figure><p>查看指定容器内部的进程信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">8f4f718740a2   centos    &quot;/bin/bash -c &#x27;while…&quot;   12 seconds ago   Up 11 seconds             goofy_hoover</span><br><span class="line">[chyris@localhost ~]$ sudo docker top 8f4f718740a2</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                11722               11700               0                   02:29               ?                   00:00:00            /bin/bash -c while true;do echo xxx;sleep 2;done</span><br><span class="line">root                11815               11722               0                   02:29               ?                   00:00:00            /usr/bin/coreutils --coreutils-prog-shebang=sleep /usr/bin/sleep 2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>UID</code> 用户ID、<code>PID</code> 当前进程ID、<code>PPID</code> 父进程ID</p><h3 id="查看镜像的元数据"><a href="#查看镜像的元数据" class="headerlink" title="查看镜像的元数据"></a>查看镜像的元数据</h3><p>查看inspect帮助文档</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker inspect --help</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line"></span><br><span class="line">Usage:  docker inspect [OPTIONS] NAME|ID [NAME|ID...]</span><br><span class="line"></span><br><span class="line">Return low-level information on Docker objects</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --format string   Format the output using the given Go template</span><br><span class="line">  -s, --size            Display total file sizes if the type is container</span><br><span class="line">      --type string     Return JSON for specified type</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查看容器信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker inspect 容器id</span><br></pre></td></tr></table></figure><p>查看指定容器信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d centos /bin/bash -c &quot;while true;do echo xxx;sleep 2;done&quot;</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">9b8dfbb1a7b5   centos    &quot;/bin/bash -c &#x27;while…&quot;   23 seconds ago   Up 22 seconds             distracted_nobel</span><br><span class="line">[chyris@localhost ~]$ sudo docker inspect 9b8dfbb1a7b5</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-09-26T19:16:02.833443366Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/bin/bash&quot;,</span><br><span class="line">        &quot;Args&quot;: [</span><br><span class="line">            &quot;-c&quot;,</span><br><span class="line">            &quot;while true;do echo xxx;sleep 2;done&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;State&quot;: &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;running&quot;,</span><br><span class="line">            &quot;Running&quot;: true,</span><br><span class="line">            &quot;Paused&quot;: false,</span><br><span class="line">            &quot;Restarting&quot;: false,</span><br><span class="line">            &quot;OOMKilled&quot;: false,</span><br><span class="line">            &quot;Dead&quot;: false,</span><br><span class="line">            &quot;Pid&quot;: 12654,</span><br><span class="line">            &quot;ExitCode&quot;: 0,</span><br><span class="line">            &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">            &quot;StartedAt&quot;: &quot;2022-09-26T19:16:03.278295629Z&quot;,</span><br><span class="line">            &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6&quot;,</span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/var/lib/docker/containers/9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5/resolv.conf&quot;,</span><br><span class="line">        &quot;HostnamePath&quot;: &quot;/var/lib/docker/containers/9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5/hostname&quot;,</span><br><span class="line">        &quot;HostsPath&quot;: &quot;/var/lib/docker/containers/9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5/hosts&quot;,</span><br><span class="line">        &quot;LogPath&quot;: &quot;/var/lib/docker/containers/9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5/9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5-json.log&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;/distracted_nobel&quot;,</span><br><span class="line">        &quot;RestartCount&quot;: 0,</span><br><span class="line">        &quot;Driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">        &quot;Platform&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;MountLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ProcessLabel&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AppArmorProfile&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ExecIDs&quot;: null,</span><br><span class="line">        &quot;HostConfig&quot;: &#123;</span><br><span class="line">            &quot;Binds&quot;: null,</span><br><span class="line">            &quot;ContainerIDFile&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LogConfig&quot;: &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;json-file&quot;,</span><br><span class="line">                &quot;Config&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;NetworkMode&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;PortBindings&quot;: &#123;&#125;,</span><br><span class="line">            &quot;RestartPolicy&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;no&quot;,</span><br><span class="line">                &quot;MaximumRetryCount&quot;: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AutoRemove&quot;: false,</span><br><span class="line">            &quot;VolumeDriver&quot;: &quot;&quot;,</span><br><span class="line">            &quot;VolumesFrom&quot;: null,</span><br><span class="line">            &quot;CapAdd&quot;: null,</span><br><span class="line">            &quot;CapDrop&quot;: null,</span><br><span class="line">            &quot;CgroupnsMode&quot;: &quot;host&quot;,</span><br><span class="line">            &quot;Dns&quot;: [],</span><br><span class="line">            &quot;DnsOptions&quot;: [],</span><br><span class="line">            &quot;DnsSearch&quot;: [],</span><br><span class="line">            &quot;ExtraHosts&quot;: null,</span><br><span class="line">            &quot;GroupAdd&quot;: null,</span><br><span class="line">            &quot;IpcMode&quot;: &quot;private&quot;,</span><br><span class="line">            &quot;Cgroup&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Links&quot;: null,</span><br><span class="line">            &quot;OomScoreAdj&quot;: 0,</span><br><span class="line">            &quot;PidMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Privileged&quot;: false,</span><br><span class="line">            &quot;PublishAllPorts&quot;: false,</span><br><span class="line">            &quot;ReadonlyRootfs&quot;: false,</span><br><span class="line">            &quot;SecurityOpt&quot;: null,</span><br><span class="line">            &quot;UTSMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;UsernsMode&quot;: &quot;&quot;,</span><br><span class="line">            &quot;ShmSize&quot;: 67108864,</span><br><span class="line">            &quot;Runtime&quot;: &quot;runc&quot;,</span><br><span class="line">            &quot;ConsoleSize&quot;: [</span><br><span class="line">                0,</span><br><span class="line">                0</span><br><span class="line">            ],</span><br><span class="line">            &quot;Isolation&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpuShares&quot;: 0,</span><br><span class="line">            &quot;Memory&quot;: 0,</span><br><span class="line">            &quot;NanoCpus&quot;: 0,</span><br><span class="line">            &quot;CgroupParent&quot;: &quot;&quot;,</span><br><span class="line">            &quot;BlkioWeight&quot;: 0,</span><br><span class="line">            &quot;BlkioWeightDevice&quot;: [],</span><br><span class="line">            &quot;BlkioDeviceReadBps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceWriteBps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceReadIOps&quot;: null,</span><br><span class="line">            &quot;BlkioDeviceWriteIOps&quot;: null,</span><br><span class="line">            &quot;CpuPeriod&quot;: 0,</span><br><span class="line">            &quot;CpuQuota&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimePeriod&quot;: 0,</span><br><span class="line">            &quot;CpuRealtimeRuntime&quot;: 0,</span><br><span class="line">            &quot;CpusetCpus&quot;: &quot;&quot;,</span><br><span class="line">            &quot;CpusetMems&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Devices&quot;: [],</span><br><span class="line">            &quot;DeviceCgroupRules&quot;: null,</span><br><span class="line">            &quot;DeviceRequests&quot;: null,</span><br><span class="line">            &quot;KernelMemory&quot;: 0,</span><br><span class="line">            &quot;KernelMemoryTCP&quot;: 0,</span><br><span class="line">            &quot;MemoryReservation&quot;: 0,</span><br><span class="line">            &quot;MemorySwap&quot;: 0,</span><br><span class="line">            &quot;MemorySwappiness&quot;: null,</span><br><span class="line">            &quot;OomKillDisable&quot;: false,</span><br><span class="line">            &quot;PidsLimit&quot;: null,</span><br><span class="line">            &quot;Ulimits&quot;: null,</span><br><span class="line">            &quot;CpuCount&quot;: 0,</span><br><span class="line">            &quot;CpuPercent&quot;: 0,</span><br><span class="line">            &quot;IOMaximumIOps&quot;: 0,</span><br><span class="line">            &quot;IOMaximumBandwidth&quot;: 0,</span><br><span class="line">            &quot;MaskedPaths&quot;: [</span><br><span class="line">                &quot;/proc/asound&quot;,</span><br><span class="line">                &quot;/proc/acpi&quot;,</span><br><span class="line">                &quot;/proc/kcore&quot;,</span><br><span class="line">                &quot;/proc/keys&quot;,</span><br><span class="line">                &quot;/proc/latency_stats&quot;,</span><br><span class="line">                &quot;/proc/timer_list&quot;,</span><br><span class="line">                &quot;/proc/timer_stats&quot;,</span><br><span class="line">                &quot;/proc/sched_debug&quot;,</span><br><span class="line">                &quot;/proc/scsi&quot;,</span><br><span class="line">                &quot;/sys/firmware&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;ReadonlyPaths&quot;: [</span><br><span class="line">                &quot;/proc/bus&quot;,</span><br><span class="line">                &quot;/proc/fs&quot;,</span><br><span class="line">                &quot;/proc/irq&quot;,</span><br><span class="line">                &quot;/proc/sys&quot;,</span><br><span class="line">                &quot;/proc/sysrq-trigger&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/71d47e380f73add20c212833476956e1bcc7abe9ca8556d9df8c32647131f69a-init/diff:/var/lib/docker/overlay2/ec7d133822e9d7981a24b358c5b4b8d39921dd05098b72c851dac47de3d3978d/diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/71d47e380f73add20c212833476956e1bcc7abe9ca8556d9df8c32647131f69a/merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/71d47e380f73add20c212833476956e1bcc7abe9ca8556d9df8c32647131f69a/diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/71d47e380f73add20c212833476956e1bcc7abe9ca8556d9df8c32647131f69a/work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Mounts&quot;: [],</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;9b8dfbb1a7b5&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;/bin/bash&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;while true;do echo xxx;sleep 2;done&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;centos&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20210915&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">            &quot;Bridge&quot;: &quot;&quot;,</span><br><span class="line">            &quot;SandboxID&quot;: &quot;04433626b38df081b13f75c13cea73112a96e6a7f3d81899a12e346d0ea6b131&quot;,</span><br><span class="line">            &quot;HairpinMode&quot;: false,</span><br><span class="line">            &quot;LinkLocalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;LinkLocalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;Ports&quot;: &#123;&#125;,</span><br><span class="line">            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/04433626b38d&quot;,</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: null,</span><br><span class="line">            &quot;SecondaryIPv6Addresses&quot;: null,</span><br><span class="line">            &quot;EndpointID&quot;: &quot;f96d7176577f0e6b133c9cc5e4c2e53afe9a76708452444df2ca3f6fd19b1799&quot;,</span><br><span class="line">            &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">            &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">            &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">            &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">            &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">            &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;bridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: null,</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;0ad51380eac702bccfcfe28fbd7f9e19001407c3657125e3f4d9a66463ad8dc3&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;f96d7176577f0e6b133c9cc5e4c2e53afe9a76708452444df2ca3f6fd19b1799&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>容器完整id：<code>&quot;Id&quot;: &quot;9b8dfbb1a7b5a8c279b231e235cd268c8494b34a0841b245483a3c4d90ed98a5&quot;</code></p><p>容器创建时间：<code>&quot;Created&quot;: &quot;2022-09-26T19:16:02.833443366Z&quot;</code></p><p>容器默认控制台：<code>&quot;Path&quot;: &quot;/bin/bash&quot;</code></p><p>传递参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;Args&quot;: [</span><br><span class="line">    &quot;-c&quot;,</span><br><span class="line">    &quot;while true;do echo xxx;sleep 2;done&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>容器状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&quot;State&quot;: &#123;</span><br><span class="line">    &quot;Status&quot;: &quot;running&quot;,    # 容器处于运行状态</span><br><span class="line">    &quot;Running&quot;: true,</span><br><span class="line">    &quot;Paused&quot;: false,</span><br><span class="line">    &quot;Restarting&quot;: false,</span><br><span class="line">    &quot;OOMKilled&quot;: false,</span><br><span class="line">    &quot;Dead&quot;: false,</span><br><span class="line">    &quot;Pid&quot;: 12654,   # 当前进程id</span><br><span class="line">    &quot;ExitCode&quot;: 0,</span><br><span class="line">    &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">    &quot;StartedAt&quot;: &quot;2022-09-26T19:16:03.278295629Z&quot;,</span><br><span class="line">    &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>来源镜像：<code>&quot;Image&quot;: &quot;sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6&quot;</code></p><p>环境变量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;Env&quot;: [</span><br><span class="line">    &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>执行命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Cmd&quot;: [</span><br><span class="line">    &quot;/bin/bash&quot;,</span><br><span class="line">    &quot;-c&quot;,</span><br><span class="line">    &quot;while true;do echo xxx;sleep 2;done&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>桥接模式网络信息：<code>&quot;Networks&quot;: &quot;bridge&quot;</code></p><h3 id="进入当前正在运行容器"><a href="#进入当前正在运行容器" class="headerlink" title="进入当前正在运行容器"></a>进入当前正在运行容器</h3><p>容器通常后台运行，需要进入容器，修改一些变量</p><p>docker exec命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -it 容器id bashShell</span><br></pre></td></tr></table></figure><p>进入指定容器进行操作，会开启一个新的终端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">9b8dfbb1a7b5   centos    &quot;/bin/bash -c &#x27;while…&quot;   16 minutes ago   Up 16 minutes             distracted_nobel</span><br><span class="line">[chyris@localhost ~]$ sudo docker exec -it 9b8dfbb1a7b5 /bin/bash</span><br><span class="line">[root@9b8dfbb1a7b5 /]# ps -ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          1      0  0 19:16 ?        00:00:00 /bin/bash -c while true;do echo xxx;sleep 2;done</span><br><span class="line">root        533      0  0 19:33 pts/0    00:00:00 /bin/bash</span><br><span class="line">root        549      1  0 19:33 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang=sleep /usr/bin/sleep 2</span><br><span class="line">root        550    533  0 19:33 pts/0    00:00:00 ps -ef</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>docker attach 命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker attach 容器id</span><br></pre></td></tr></table></figure><p>进入一个正在执行的终端，不会启动新的进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker attach 9b8dfbb1a7b5</span><br><span class="line">当前代码正在执行...</span><br></pre></td></tr></table></figure><h3 id="从容器内拷贝文件到主机"><a href="#从容器内拷贝文件到主机" class="headerlink" title="从容器内拷贝文件到主机"></a>从容器内拷贝文件到主机</h3><p>使用 <code>docker cp</code> 命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 容器id:容器内路径 目的主机路径</span><br></pre></td></tr></table></figure><p>容器内创建文件，在并外部拷贝出来到主机上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost home]$ ls</span><br><span class="line">chyris</span><br><span class="line">[chyris@localhost home]$ sudo docker attach b6a96dd6b157</span><br><span class="line">[root@b6a96dd6b157 /]# cd /home</span><br><span class="line">[root@b6a96dd6b157 home]# ls</span><br><span class="line">[root@b6a96dd6b157 home]# touch a.py</span><br><span class="line">[root@b6a96dd6b157 home]# ls</span><br><span class="line">a.py</span><br><span class="line">[root@b6a96dd6b157 home]# exit</span><br><span class="line">exit</span><br><span class="line">[chyris@localhost home]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">[chyris@localhost home]$ sudo docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED         STATUS                      PORTS     NAMES</span><br><span class="line">b6a96dd6b157   centos    &quot;/bin/bash&quot;   8 minutes ago   Exited (0) 15 seconds ago             peaceful_dirac</span><br><span class="line">[chyris@localhost home]$ sudo docker cp b6a96dd6b157:/home/a.py /home</span><br><span class="line">[chyris@localhost home]$ ls /home</span><br><span class="line">a.py  chyris</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>cp命令是手动拷贝过程，未来也可以使用-v卷的技术，将容器内指定目录和主机内指定目录自动同步。</p><h3 id="命令小结"><a href="#命令小结" class="headerlink" title="命令小结"></a>命令小结</h3><p>查看<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/docker/">官方文档</a>对理解下列命令将会有所帮助</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E5%91%BD%E4%BB%A4.png" title="This is an docker命令 image"><h2 id="docker命令练习"><a href="#docker命令练习" class="headerlink" title="docker命令练习"></a>docker命令练习</h2><p>使用<a target="_blank" rel="noopener" href="https://hub.docker.com/search?q=">hub.docker</a>的示例将会对你有所帮助。</p><h3 id="部署nginx"><a href="#部署nginx" class="headerlink" title="部署nginx"></a>部署nginx</h3><p>搜索nginx，建议去docker hub上搜索</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker search nginx</span><br></pre></td></tr></table></figure><p>搜索结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost home]$ sudo docker search nginx</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">NAME                                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">nginx                                             Official build of Nginx.                        17445     [OK]       </span><br><span class="line">linuxserver/nginx                                 An Nginx container, brought to you by LinuxS…   178                  </span><br><span class="line">bitnami/nginx                                     Bitnami nginx Docker Image                      140                  [OK]</span><br></pre></td></tr></table></figure><p>下载镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull nginx</span><br></pre></td></tr></table></figure><p>默认下载最新版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost home]$ sudo docker pull nginx</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">a2abf6c4d29d: Pull complete </span><br><span class="line">a9edb18cadd1: Pull complete </span><br><span class="line">589b7251471a: Pull complete </span><br><span class="line">186b1aaa4aa6: Pull complete </span><br><span class="line">b4df32aa5a72: Pull complete </span><br><span class="line">a0bcbecc962e: Pull complete </span><br><span class="line">Digest: sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</span><br><span class="line">Status: Downloaded newer image for nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br></pre></td></tr></table></figure><p>运行测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost home]$ sudo docker images</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        latest    605c77e624dd   9 months ago    141MB</span><br><span class="line">centos       latest    5d0da3dc9764   12 months ago   231MB</span><br><span class="line">[chyris@localhost home]$ sudo docker run -d --name nginx01 -p 2022:80 nginx</span><br><span class="line">35b4983079e2e1cb3954656ca5500a23859ca3b6a359cec1333c7208cd0ce25f</span><br><span class="line">[chyris@localhost home]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                                   NAMES</span><br><span class="line">35b4983079e2   nginx     &quot;/docker-entrypoint.…&quot;   12 seconds ago   Up 10 seconds   0.0.0.0:2022-&gt;80/tcp, :::2022-&gt;80/tcp   nginx01</span><br><span class="line">[chyris@localhost home]$ curl localhost:2022</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>外部访问</p><p>使用<code>ip addr</code>命令查看主机ip地址，然后在浏览器输入<code>http://ip:2022</code>出现nginx欢迎页面即为部署成功。</p><p>进入容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost home]$ sudo docker exec -it nginx01 /bin/bash</span><br><span class="line">root@35b4983079e2:/# whereis nginx</span><br><span class="line">nginx: /usr/sbin/nginx /usr/lib/nginx /etc/nginx /usr/share/nginx</span><br><span class="line">root@35b4983079e2:/# ls</span><br><span class="line">bin   dev		   docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">boot  docker-entrypoint.d  etc			 lib   media  opt  root  sbin  sys  usr</span><br><span class="line">root@35b4983079e2:/# cd /etc/nginx/</span><br><span class="line">root@35b4983079e2:/etc/nginx# ls</span><br><span class="line">conf.d	fastcgi_params	mime.types  modules  nginx.conf  scgi_params  uwsgi_params</span><br></pre></td></tr></table></figure><p>停止容器后，服务将不可访问</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@35b4983079e2:/etc/nginx# exit</span><br><span class="line">exit</span><br><span class="line">[chyris@localhost home]$ sudo docker ps</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                                   NAMES</span><br><span class="line">35b4983079e2   nginx     &quot;/docker-entrypoint.…&quot;   26 minutes ago   Up 26 minutes   0.0.0.0:2022-&gt;80/tcp, :::2022-&gt;80/tcp   nginx01</span><br><span class="line">[chyris@localhost home]$ sudo docker stop 35b4983079e2</span><br><span class="line">35b4983079e2</span><br></pre></td></tr></table></figure><p>端口暴露的概念</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E7%AB%AF%E5%8F%A3%E6%9A%B4%E9%9C%B2.png" title="This is an 端口暴露.png image"><p>进入容器内部以后，可以修改配置文件，但是每次改动都要进入容器内部，效率不高，使用数据卷-v技术，可以实现在容器外部提供一个映射路径，每次在容器外部的修改都可以自动对容器内部进行修改。</p><h3 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h3><p>docker hub官方方式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm tomcat:9.0</span><br></pre></td></tr></table></figure><p>–rm 表示用完即删，一般用于测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -it --rm tomcat:9.0</span><br><span class="line">Unable to find image &#x27;tomcat:9.0&#x27; locally</span><br><span class="line">9.0: Pulling from library/tomcat</span><br><span class="line">安装启动...</span><br></pre></td></tr></table></figure><p>由于本地没有tomcat，所以从远程仓库下载，完成后直接交互式启动</p><p>一般情况下，使用以下顺序来部署tomcat，先下载，在运行</p><p>下载最新版本的tomcat</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull tomcat</span><br></pre></td></tr></table></figure><p>运行tomcat</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -p 8080:8080 --name tomcat01 tomcat</span><br></pre></td></tr></table></figure><p>使用curl命令测试访问成功，但是返回404</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ curl localhost:8080</span><br><span class="line">&lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP Status 404 – Not Found&lt;/title&gt;&lt;style type=&quot;text/css&quot;&gt;body &#123;font-family:Tahoma,Arial,sans-serif;&#125; h1, h2, h3, b &#123;color:white;background-color:#525D76;&#125; h1 &#123;font-size:22px;&#125; h2 &#123;font-size:16px;&#125; h3 &#123;font-size:14px;&#125; p &#123;font-size:12px;&#125; a &#123;color:black;&#125; .line &#123;height:1px;background-color:#525D76;border:none;&#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 404 – Not Found&lt;/h1&gt;&lt;hr class=&quot;line&quot; /&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt; Status Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The origin server did not find a current representation for the target resource or is not willing to disclose that one exists.&lt;/p&gt;&lt;hr class=&quot;line&quot; /&gt;&lt;h3&gt;Apache Tomcat/10.0.14&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;[chyris@localhost ~]$ </span><br></pre></td></tr></table></figure><p>由于使用的网络模式为桥接，所以虚拟主机接受了路由器的DHCP动态分配IP，且虚拟主机与容器进行了端口映射，所以可以在外部直接使用<a href="http://ip:8080来访问。">http://ip:8080来访问。</a></p><p>实际测试浏览器返回404页面</p><p>进入容器后发现，命令缺失且webapps内容为空。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 /bin/bash</span><br><span class="line">root@6bff55d738f9:/usr/local/tomcat# ll -a</span><br><span class="line">bash: ll: command not found</span><br><span class="line">root@6bff55d738f9:/usr/local/tomcat# ls -a</span><br><span class="line">.		 LICENSE	RUNNING.txt  logs	     webapps.dist</span><br><span class="line">..		 NOTICE		bin	     native-jni-lib  work</span><br><span class="line">BUILDING.txt	 README.md	conf	     temp</span><br><span class="line">CONTRIBUTING.md  RELEASE-NOTES	lib	     webapps       </span><br><span class="line">root@6bff55d738f9:/usr/local/tomcat# ls webapps</span><br></pre></td></tr></table></figure><p>阿里云镜像的原因，默认是最小的镜像，剔除不必要的内容，保证最小可运行的环境。</p><p>将容器内webapps.dist中的内容复制到webapps目录中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@6bff55d738f9:/usr/local/tomcat# cp -r webapps.dist/* webapps</span><br><span class="line">root@6bff55d738f9:/usr/local/tomcat# ls webapps</span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br></pre></td></tr></table></figure><p>浏览器重新访问：<code>http://虚拟主机ip:8080</code>即可成功进入网站起始页。</p><p>部署tomcat需要进入容器内部，修改文件和目录，但是每次改动都要进入容器内部，效率不高，使用数据卷-v技术，可以实现在容器外部提供一个映射路径，每次在容器外部的修改都可以自动对容器内部进行修改。</p><h3 id="部署es-Kibana"><a href="#部署es-Kibana" class="headerlink" title="部署es+Kibana"></a>部署es+Kibana</h3><p>安装运行elasticsearch镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker network create somenetwork</span><br><span class="line"></span><br><span class="line">sudo docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:tag</span><br></pre></td></tr></table></figure><p><code>--net somenetwork</code> docker网络<br><code>-e &quot;discovery.type=single-node&quot;</code> 默认单节点集群</p><p>使用一个es版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.6.2</span><br></pre></td></tr></table></figure><p>如果内存太小会导致系统卡顿，请先关闭其它服务节省内存</p><p>容器运行成功后，进行端口测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND                  CREATED         STATUS         PORTS                                                                                  NAMES</span><br><span class="line">fccdf3420c88   elasticsearch:7.6.2   &quot;/usr/local/bin/dock…&quot;   5 minutes ago   Up 5 minutes   0.0.0.0:9200-&gt;9200/tcp, :::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp, :::9300-&gt;9300/tcp   elasticsearch</span><br><span class="line">[chyris@localhost ~]$ curl localhost:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;fccdf3420c88&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;5OLLzqG2SSSEZz9S-TxTuQ&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.6.2&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;docker&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2020-03-26T06:34:37.794943Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.4.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>sudo docker stats</code>查看内存占用情况，消耗很大，需要添加内存限制。</p><p>停止容器，修改配置文件 -e 环境配置修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name elasticsearch01 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; elasticsearch:7.6.2</span><br></pre></td></tr></table></figure><p>命令<code>sudo docker stats</code>查看内存占用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O         PIDS</span><br><span class="line">0a72e1881177   elasticsearch01   0.67%     296.7MiB / 972.4MiB   30.51%    656B / 0B   4.35GB / 2.31MB   43</span><br><span class="line"></span><br><span class="line">`curl`命令测试容器运行</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">[chyris@localhost ~]$ curl localhost:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;0a72e1881177&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;nj5JWgUzQoWY0E6hXtmpTg&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.6.2&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;docker&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2020-03-26T06:34:37.794943Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.4.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>docker网络原理，实现访问可达</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E7%BD%91%E7%BB%9C.png" title="This is an docker网络 image"><h2 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h2><h3 id="portainer"><a href="#portainer" class="headerlink" title="portainer"></a>portainer</h3><p>portainer是Docker图形化界面管理工具，提供后台面板可直接操作。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -p 8088:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer</span><br></pre></td></tr></table></figure><p>访问测试，访问外网8088端口，进入默认页面：<code>http://192.168.0.105:8088/#/init/admin</code>，因为我的主机名就是桥接网卡的IP，所以可以直接以内网访问。</p><p>设置完密码，可以使用local本地连接正在运行portainer的docker环境，之后就可以实现对容器镜像以及其它docker内容的可视化管理。</p><h3 id="Rancher-CI-x2F-CD"><a href="#Rancher-CI-x2F-CD" class="headerlink" title="Rancher(CI&#x2F;CD)"></a>Rancher(CI&#x2F;CD)</h3><p>pass</p><h2 id="Docker镜像"><a href="#Docker镜像" class="headerlink" title="Docker镜像"></a>Docker镜像</h2><h3 id="什么是镜像"><a href="#什么是镜像" class="headerlink" title="什么是镜像"></a>什么是镜像</h3><p>镜像是一种轻量级、可执行的独立软件包，它包含运行某个软件所需的所有内容，我们把应用程序和配置依赖打包好行程一个可交付的运行环境（包括代码、运行时需要的库、环境变量和配置文件等），这个打包好的运行环境就是image镜像文件。</p><p>获取一个docker镜像可以有多种方式，分为在线和离线获取。</p><h3 id="docker镜像获取"><a href="#docker镜像获取" class="headerlink" title="docker镜像获取"></a>docker镜像获取</h3><h4 id="docker-pull"><a href="#docker-pull" class="headerlink" title="docker pull"></a>docker pull</h4><p>从registry拉取，分为共有和私有：docker pull from registry(online)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull container_name[:version]</span><br></pre></td></tr></table></figure><h4 id="docker-build"><a href="#docker-build" class="headerlink" title="docker build"></a>docker build</h4><p>从Dockerfile构建：docker build from Dockerfile(online)</p><p>需要确保docker命令执行路径和Dockerfile文件路径一致</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker build -t target_name:version</span><br></pre></td></tr></table></figure><h4 id="docker-load"><a href="#docker-load" class="headerlink" title="docker load"></a>docker load</h4><p>加载一个文件成为镜像：docker load from image file(offline)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker image load -i 文件名.image</span><br></pre></td></tr></table></figure><p>将一个镜像导出成一个文件(offline)<br>sudo docker image save 镜像名称:版本号 -o 文件名称.image</p><h4 id="docker-commit"><a href="#docker-commit" class="headerlink" title="docker commit"></a>docker commit</h4><p>将容器里面运行的程序及运行环境打包生成新的镜像：docker commit from container</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker commit [选项] 容器ID/名称 仓库名称[:标签]</span><br><span class="line">-m：说明信息</span><br><span class="line">-a：作者信息</span><br><span class="line">-p：生成过程中停止容器的运行</span><br></pre></td></tr></table></figure><h4 id="docker-import"><a href="#docker-import" class="headerlink" title="docker import"></a>docker import</h4><p>从归档文件中创建镜像：docker import from tar file。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker import [OPTIONS] file|URL|- [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">-c 应用docker 指令创建镜像；</span><br><span class="line">-m 提交时的说明文字；</span><br></pre></td></tr></table></figure><p>例如从tar文件中导入centos镜像，并指定仓库名称和版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker import my_centos_v1.tar repos/centos:v2</span><br></pre></td></tr></table></figure><p>docker export:将文件系统作为一个tar归档文件导出到STDOUT。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker export [OPTIONS] CONTAINER</span><br><span class="line"></span><br><span class="line">-o 将输入内容写到文件</span><br></pre></td></tr></table></figure><p>将id为a404c6c174a2的容器按日期保存为tar文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~$ docker export -o mysql-`date +%Y%m%d`.tar a404c6c174a2</span><br><span class="line">root@localhost:~$ ls mysql-`date +%Y%m%d`.tar</span><br><span class="line">mysql-20160711.tar</span><br></pre></td></tr></table></figure><h3 id="Docker-镜像加载原理"><a href="#Docker-镜像加载原理" class="headerlink" title="Docker 镜像加载原理"></a>Docker 镜像加载原理</h3><h4 id="UnionFS（联合文件系统）"><a href="#UnionFS（联合文件系统）" class="headerlink" title="UnionFS（联合文件系统）"></a>UnionFS（联合文件系统）</h4><p>Docker 中的文件存储驱动叫做 storage driver。</p><p>Docker 最早支持的stotage driver是 AUFS，它实际上由一层一层的文件系统组成，这种层级的文件系统叫UnionFS。</p><p>联合文件系统（UnionFS）：Union 文件系统，是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将不同目录挂载到同一个虚拟文件系统下（unite serveral directories into a single virtual filesystem）。</p><p>Union文件系统是Docker镜像的基础。镜像可以通过分层来进行集成，基于基础镜像可以制作具体的应用镜像。</p><p>特性：一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</p><p>后来出现的docker版本中，除了AUFS，还支持OverlayFS、Btrfs、Device Mapper、VFS、ZFS等storage driver。</p><h4 id="bootfs和rootfs"><a href="#bootfs和rootfs" class="headerlink" title="bootfs和rootfs"></a>bootfs和rootfs</h4><p>bootfs（boot file system）主要包含 bootloader 和 kernel，bootloader主要是引导加载 kernel，Linux刚启动时会加载bootfs文件系统。</p><p>在Docker镜像的最底层是引导文件系统bootfs。这一层与我们典型的Linux&#x2F;Unix系统是一样的，包含boot加载器和内核。当boot加载完成之后整个内核就都在内存中了，此时内存的使用权已经由 bootfs 转交给内核，此时系统也会卸载 bootfs。</p><p>rootfs（root file system），在bootfs之上，包含的就是典型Linux系统中的 &#x2F;dev、&#x2F;proc、&#x2F;bin、&#x2F;etc等标准目录和文件。rootfs就是各种不同的操作系统发行版，比如Ubuntu、CentOS等。</p><p>docker镜像底层层次：</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/bootfs.png" title="This is an bootfs.png image"><p>对于一个精简的OS，rootfs可以很小，只需要包括最基本的命令、工具和程序库就可以了，因为底层直接使用Host的Kernel，自己只需要提供rootfs就可以。所以，对于不同的Linux发行版，bootfs基本是一致的，rootfs会有差别，不同的发行版可以共用bootfs。</p><p>有差别的rootfs</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/rootfs.png" title="This is an rootfs.png image"><h4 id="镜像分层"><a href="#镜像分层" class="headerlink" title="镜像分层"></a>镜像分层</h4><p>Docker镜像的分层，在镜像下载时就有体现。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker pull redis</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/redis</span><br><span class="line">a2abf6c4d29d: Already exists </span><br><span class="line">c7a4e4382001: Pull complete </span><br><span class="line">4044b9ba67c9: Pull complete </span><br><span class="line">c8388a79482f: Pull complete </span><br><span class="line">413c8bb60be2: Pull complete </span><br><span class="line">1abfd3011519: Pull complete </span><br><span class="line">Digest: sha256:db485f2e245b5b3329fdc7eff4eb00f913e09d8feb9ca720788059fdc2ed8339</span><br><span class="line">Status: Downloaded newer image for redis:latest</span><br><span class="line">docker.io/library/redis:latest</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用命令<code>sudo docker image inspect redis:latest</code>就可以查看具体的镜像分层结构。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;RootFS&quot;: &#123;</span><br><span class="line">    &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">    &quot;Layers&quot;: [</span><br><span class="line">        &quot;sha256:2edcec3590a4ec7f40cf0743c15d78fb39d8326bc029073b41ef9727da6c851f&quot;,</span><br><span class="line">        &quot;sha256:9b24afeb7c2f21e50a686ead025823cd2c6e9730c013ca77ad5f115c079b57cb&quot;,</span><br><span class="line">        &quot;sha256:4b8e2801e0f956a4220c32e2c8b0a590e6f9bd2420ec65453685246b82766ea1&quot;,</span><br><span class="line">        &quot;sha256:529cdb636f61e95ab91a62a51526a84fd7314d6aab0d414040796150b4522372&quot;,</span><br><span class="line">        &quot;sha256:9975392591f2777d6bf4d9919ad1b2c9afa12f9a9b4d260f45025ec3cc9b18ed&quot;,</span><br><span class="line">        &quot;sha256:8e5669d8329116b8444b9bbb1663dda568ede12d3dbcce950199b582f6e94952&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>其中 <code>&quot;sha256:2edcec359...</code> 就是一个已经安装（Already exists）的linux发行版。</p><p>Docker支持扩展现有镜像，创建新的镜像。新镜像是从base镜像一层一层叠加生成的。</p><p>例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Version: 0.0.1</span></span><br><span class="line">FROM debian  # 直接在debain base镜像上构建</span><br><span class="line">MAINTAINER mylinux</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y emacs # 安装emacs</span><br><span class="line">RUN apt-get install -y apache2 # 安装apache2</span><br><span class="line">CMD [&quot;/bin/bash&quot;] # 容器启动时运行bash</span><br></pre></td></tr></table></figure><p>镜像创建过程：</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82.png" title="This is an 镜像分层.png image"><p>镜像分层的一个最大好处就是共享资源，方便复制迁移，方便复用。</p><h4 id="容器层"><a href="#容器层" class="headerlink" title="容器层"></a>容器层</h4><p>当容器启动时，一个新的可写层将被加载到镜像的顶部，这一层通常被称为容器层，容器层之下的都叫镜像层。</p><p>所有对容器的改动，无论添加、删除、还是修改文件都只会发生在容器层中。</p><p>只有容器层是可写的，容器层下面的所有镜像层都是只读的。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E5%AE%B9%E5%99%A8%E5%B1%82.png" title="This is an 容器层.png image"><h4 id="commit镜像"><a href="#commit镜像" class="headerlink" title="commit镜像"></a>commit镜像</h4><p>使用<code>docker commit</code>提交一个容器成为一个新的副本，命令和git原理类似</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit -m=&quot;提交的描述信息&quot; -a=&quot;作者&quot; 容器id 目标镜像名[:TAG]</span><br></pre></td></tr></table></figure><p>对使用默认版本tomcat运行的容器，由于站点内容的缺失，需要对webapps文件夹中添加一些站点内容才能使用。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND             CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">fa54175ebde3   tomcat:latest         &quot;catalina.sh run&quot;   23 seconds ago   Up 22 seconds   8080/tcp                                    crazy_wu</span><br><span class="line">[chyris@localhost ~]$ sudo docker exec -it crazy_wu /bin/bash</span><br><span class="line">root@fa54175ebde3:/usr/local/tomcat# ls</span><br><span class="line">BUILDING.txt  CONTRIBUTING.md  LICENSE	NOTICE	README.md  RELEASE-NOTES  RUNNING.txt  bin  conf  lib  logs  native-jni-lib  temp  webapps  webapps.dist  work</span><br><span class="line">root@fa54175ebde3:/usr/local/tomcat# ls webapps</span><br><span class="line">root@fa54175ebde3:/usr/local/tomcat# ls webapps.dist/</span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@fa54175ebde3:/usr/local/tomcat# cp -r webapps.dist/* webapps</span><br><span class="line">root@fa54175ebde3:/usr/local/tomcat# ls webapps</span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@fa54175ebde3:/usr/local/tomcat# exit</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>退出容器后，可以对当前正在运行的容器进行commit获取一个新版本的镜像，改镜像将保留之前在容器中对webapps目录做的修改。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND             CREATED         STATUS         PORTS                                       NAMES</span><br><span class="line">78e0fe6bd84c   tomcat:latest         &quot;catalina.sh run&quot;   5 minutes ago   Up 5 minutes   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   sweet_banach</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker commit -m=&quot;add webapps app&quot; -a=&quot;chyris&quot; 78e0fe6bd84c tomcat02:1.0</span><br><span class="line">sha256:4ca2d35f5039c9b5d0cd39dfa275bf5ab1d017a07308bb96604b19e1902a1dc1</span><br></pre></td></tr></table></figure><p>此时使用8081端口直接运行该镜像，浏览器即可直接访问到正常的页面。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">tomcat02              1.0       4ca2d35f5039   11 seconds ago   684MB</span><br><span class="line">nginx                 latest    605c77e624dd   9 months ago     141MB</span><br><span class="line">tomcat                9.0       b8e65a4d736d   9 months ago     680MB</span><br><span class="line">tomcat                latest    fb5657adc892   9 months ago     680MB</span><br><span class="line">redis                 latest    7614ae9453d1   9 months ago     113MB</span><br><span class="line">centos                latest    5d0da3dc9764   12 months ago    231MB</span><br><span class="line">portainer/portainer   latest    580c0e4e98b0   18 months ago    79.1MB</span><br><span class="line">elasticsearch         7.6.2     f29a1ee41030   2 years ago      791MB</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker run -d -p 8081:8080 tomcat02:1.0</span><br><span class="line">da651daa4da552d2d253047ed4e37638c2f9baeb075b21b357cdb82beec7a58a</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND             CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">da651daa4da5   tomcat02:1.0          &quot;catalina.sh run&quot;   6 minutes ago    Up 6 minutes    0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   modest_lumiere</span><br><span class="line">78e0fe6bd84c   tomcat:latest         &quot;catalina.sh run&quot;   14 minutes ago   Up 14 minutes   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   sweet_banach</span><br></pre></td></tr></table></figure><h2 id="容器数据卷"><a href="#容器数据卷" class="headerlink" title="容器数据卷"></a>容器数据卷</h2><h3 id="什么是容器数据卷"><a href="#什么是容器数据卷" class="headerlink" title="什么是容器数据卷"></a>什么是容器数据卷</h3><p>Docker 是将应用和环境打包成一个镜像。发布之后通过运行就变成一个容器。</p><p>这样，数据就不应该保存在容器中，否则容器删除，数据就会丢失，有着非常大的风险。</p><p>例如，使用 docker 安装 MySQL，如果将 MySQL 容器删除，会导致MySQL中存的数据也丢失。</p><p>如果有一个数据持久化存储的方法，确保容器和主机都能保留这部分数据，那么就可以解决这个问题。</p><p>为此，容器和主机之间需要有一个数据共享技术，使得在 Docker 容器中产生的数据能够同步到本地。</p><p>这就是数据卷技术。其本质上是一个目录挂载，将容器内的目录挂载到主机上。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/volume.png" title="This is an docker volume image"><p>总结一句话：容器的持久化和同步操作！容器间也是可以数据共享的！</p><h3 id="使用数据卷"><a href="#使用数据卷" class="headerlink" title="使用数据卷"></a>使用数据卷</h3><h4 id="直接使用命令挂载"><a href="#直接使用命令挂载" class="headerlink" title="直接使用命令挂载"></a>直接使用命令挂载</h4><p>将容器内的目录挂载到主机上，需要在命令中指定 -v 参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it -v 主机目录:容器内目录</span><br></pre></td></tr></table></figure><p>启动一个centos，并将主机目录<code>/home/test</code>和容器目录<code>/home</code>挂载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls /home</span><br><span class="line">a.py  chyris</span><br><span class="line">[chyris@localhost ~]$ sudo docker run -it -v /home/test:/home centos /bin/bash</span><br><span class="line">[root@46d0800eec5a /]# ls /home</span><br></pre></td></tr></table></figure><p>已经在主机<code>/home</code>目录下建立了一个 test 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls /home</span><br><span class="line">a.py  chyris  test</span><br></pre></td></tr></table></figure><p>使用命令 <code>sudo docker inspect 46d0800eec5a</code> 查看刚才创建的容器，发现容器的挂载信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/home/test&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;/home&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>此时在容器的 <code>/home</code> 目录下写入一个 <code>test.py</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@46d0800eec5a /]# touch /home/test.py</span><br><span class="line">[root@46d0800eec5a /]# ls /home/       </span><br><span class="line">test.py</span><br></pre></td></tr></table></figure><p>查看主机的 <code>/home/test</code> 目录，已经存在了一个相同的 <code>test.py</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls /home/test</span><br><span class="line">test.py</span><br></pre></td></tr></table></figure><p>在主机的 <code>/home/test</code> 目录创建一个 <code>test.java</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo touch /home/test/test.java</span><br><span class="line">[chyris@localhost ~]$ ls /home/test</span><br><span class="line">test.java  test.py</span><br></pre></td></tr></table></figure><p>查看容器内的 <code>/home</code> 目录，已经存在一个 <code>test.java</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@46d0800eec5a /]# ls /home </span><br><span class="line">test.java  test.py</span><br></pre></td></tr></table></figure><p>在容器中删除 <code>/home</code> 目录下的 <code>test.java</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@46d0800eec5a /]# rm -f /home/test.java</span><br><span class="line">[root@46d0800eec5a /]# ls /home</span><br><span class="line">test.py</span><br></pre></td></tr></table></figure><p>查看主机的 <code>/home/test</code> 目录，只剩下一个文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls /home/test</span><br><span class="line">test.py</span><br></pre></td></tr></table></figure><p>退出并停止容器，在主机的 <code>/home/test</code> 目录下创建一个 <code>test.jar</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@46d0800eec5a /]# exit </span><br><span class="line">exit</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND        CREATED        STATUS          PORTS                                       NAMES</span><br><span class="line">cb1384475730   portainer/portainer   &quot;/portainer&quot;   27 hours ago   Up 42 minutes   0.0.0.0:8088-&gt;9000/tcp, :::8088-&gt;9000/tcp   tender_shannon</span><br><span class="line">[chyris@localhost ~]$ sudo touch /home/test/test.jar</span><br><span class="line">[chyris@localhost ~]$ ls /home/test/</span><br><span class="line">test.jar  test.py</span><br></pre></td></tr></table></figure><p>此时运行刚才的容器并进入容器内部，发现容器内部的 <code>/home</code> 目录下已经有一个 <code>test.jar</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND                  CREATED          STATUS                        PORTS                                       NAMES</span><br><span class="line">46d0800eec5a   centos                &quot;/bin/bash&quot;              38 minutes ago   Exited (0) 2 minutes ago                                                  amazing_yalow</span><br><span class="line">da651daa4da5   tomcat02:1.0          &quot;catalina.sh run&quot;        22 hours ago     Exited (255) 44 minutes ago   0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   modest_lumiere</span><br><span class="line">78e0fe6bd84c   tomcat:latest         &quot;catalina.sh run&quot;        22 hours ago     Exited (255) 44 minutes ago   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   sweet_banach</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker start 46d0800eec5a</span><br><span class="line">46d0800eec5a</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND        CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">46d0800eec5a   centos                &quot;/bin/bash&quot;    40 minutes ago   Up 39 seconds                                               amazing_yalow</span><br><span class="line">cb1384475730   portainer/portainer   &quot;/portainer&quot;   27 hours ago     Up 45 minutes   0.0.0.0:8088-&gt;9000/tcp, :::8088-&gt;9000/tcp   tender_shannon</span><br><span class="line">[chyris@localhost ~]$ sudo docker attach 46d0800eec5a</span><br><span class="line">[root@46d0800eec5a /]# ls /home</span><br><span class="line">test.jar  test.py</span><br></pre></td></tr></table></figure><p>说明容器 <code>/home</code> 目录 和主机 <code>/home/test</code> 目录实现了数据共享</p><p>这种同步的过程，可以理解为双向绑定，这就是容器数据卷技术。</p><p>好处：使用数据卷挂载之后，只需要在本地修改，容器内会自动同步。</p><h4 id="MySql容器数据持久化"><a href="#MySql容器数据持久化" class="headerlink" title="MySql容器数据持久化"></a>MySql容器数据持久化</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取MySQL镜像</span></span><br><span class="line">sudo docker pull mysql:5.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动MySQL容器</span></span><br><span class="line">sudo docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root --name mysql01 mysql:5.7</span><br></pre></td></tr></table></figure><ul><li>-d 后台运行</li><li>-p 端口映射</li><li>-v 数据卷挂载</li><li>-e 环境配置</li><li>–name 容器名字</li><li><code>-e MYSQL_ROOT_PASSWORD=root</code> 配置MySQL初始密码，<code>-e</code> 表示配置环境</li></ul><p>在本地使用 mysql 命令连接容器内的 MySQL 进行测试。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xxx&gt;mysql -uroot -p --host=192.168.0.105 --port=3310</span><br><span class="line">Enter password: ****</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.36 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt;</span></span><br></pre></td></tr></table></figure><p>本地连接成功，主机3310和容器内3306端口映射成功。说明 docker 部署没有问题。</p><p>查看主机的 <code>/home/mysql/data</code> 目录，发现数据已经从容器内同步过来。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls /home/mysql/data</span><br><span class="line">auto.cnf         client-key.pem  ib_logfile1         public_key.pem</span><br><span class="line">ca-key.pem       ib_buffer_pool  mysql               server-cert.pem</span><br><span class="line">ca.pem           ibdata1         performance_schema  server-key.pem</span><br><span class="line">client-cert.pem  ib_logfile0     private_key.pem     sys</span><br></pre></td></tr></table></figure><p>在本地创建一个数据库 <code>test</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure><p>即容器内创建一个数据库 <code>test</code>，查看主机上的 <code>/home/mysql/data</code> 目录，多了个 <code>test</code> 数据库，数据已经同步</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls /home/mysql/data</span><br><span class="line">auto.cnf         client-key.pem  ib_logfile1         public_key.pem   test</span><br><span class="line">ca-key.pem       ib_buffer_pool  mysql               server-cert.pem</span><br><span class="line">ca.pem           ibdata1         performance_schema  server-key.pem</span><br><span class="line">client-cert.pem  ib_logfile0     private_key.pem     sys</span><br></pre></td></tr></table></figure><p>此时把所有的容器删除，发现主机 <code>/home/mysql/data</code> 目录下数据任然存在。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker rm -f $(sudo docker ps -aq)</span><br><span class="line">9d631bd5c180</span><br><span class="line">[chyris@localhost ~]$ sudo docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">[chyris@localhost ~]$ ls /home/mysql/data</span><br><span class="line">auto.cnf         client-key.pem  ib_logfile1         private_key.pem  sys</span><br><span class="line">ca-key.pem       ib_buffer_pool  ibtmp1              public_key.pem   test</span><br><span class="line">ca.pem           ibdata1         mysql               server-cert.pem</span><br><span class="line">client-cert.pem  ib_logfile0     performance_schema  server-key.pem</span><br></pre></td></tr></table></figure><p>实现了容器数据的持久化存储，保证挂载到本地的数据卷不会丢失。</p><p>如果此时再次运行一个 mysql 并挂载到相同目录，数据依然存在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chyris@localhost ~]$ sudo docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root --name mysql01 mysql:5.7</span><br><span class="line">6ef5583ae19c622c9c5aa2d0af29f0d974555c4737bbcdfe642230eb8ddbad8a</span><br><span class="line">[chyris@localhost ~]$ ls /home/mysql/data</span><br><span class="line">auto.cnf         client-key.pem  ib_logfile1         private_key.pem  sys</span><br><span class="line">ca-key.pem       ib_buffer_pool  ibtmp1              public_key.pem   test</span><br><span class="line">ca.pem           ibdata1         mysql               server-cert.pem</span><br><span class="line">client-cert.pem  ib_logfile0     performance_schema  server-key.pem</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>进入到容器内部，发现 <code>/var/lib/mysql</code> 中的数据也被主机内容同步。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS                                                  NAMES</span><br><span class="line">6ef5583ae19c   mysql:5.7   &quot;docker-entrypoint.s…&quot;   9 minutes ago   Up 9 minutes   33060/tcp, 0.0.0.0:3310-&gt;3306/tcp, :::3310-&gt;3306/tcp   mysql01</span><br><span class="line">[chyris@localhost ~]$ sudo docker exec -it mysql01 /bin/bash</span><br><span class="line">root@6ef5583ae19c:/# ls /var/lib/mysql  </span><br><span class="line">auto.cnf	 client-key.pem  ibdata1	     private_key.pem  sys</span><br><span class="line">ca-key.pem	 ib_buffer_pool  ibtmp1		     public_key.pem   test</span><br><span class="line">ca.pem		 ib_logfile0	 mysql		     server-cert.pem</span><br><span class="line">client-cert.pem  ib_logfile1	 performance_schema  server-key.pem</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="具名和匿名挂载"><a href="#具名和匿名挂载" class="headerlink" title="具名和匿名挂载"></a>具名和匿名挂载</h3><p>匿名挂载：-v 容器内路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br></pre></td></tr></table></figure><p><code>docker volume</code>：操作容器外所有挂载点，查看 <code>docker volume</code> 帮助</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker volume --help</span><br></pre></td></tr></table></figure><p>上述 <code>-v /etc/nginx nginx</code> 只指定了容器内的挂载点，没有指定容器外的挂载点。查看所有数据卷，一堆随机字符串对应的特殊路径就是一个对应着真实目录的容器外主机匿名挂载点。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker volume ls</span><br></pre></td></tr></table></figure><p>没有名字而是一堆随机字符串的的就是匿名卷挂载，字符串对应的特殊路径就是匿名挂载的挂载点。有名字的就是具名挂载，名字对应的特殊路径就是具名挂载的挂载点。</p><p>具名挂载：-v 指定卷名:容器内路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx nginx</span><br></pre></td></tr></table></figure><p>使用 <code>docker volume ls</code> 查看，发现具名挂载存在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx nginx</span><br><span class="line">88dfccc5a5680814d9a5f5201d2be65fab2c7ede890c0be266d64fbc50405b76</span><br><span class="line">[chyris@localhost ~]$ sudo docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     6cc337c3651f9e8bc17049993376615a8105e70b1db727c98aa9f74e4cc176a8</span><br><span class="line">local     54ad8998dec11b6869c177a82fac32b058ca7d9974b3317b521a29068cd7d48b</span><br><span class="line">local     juming-nginx</span><br></pre></td></tr></table></figure><p>查询具名挂载详情</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker volume inspect juming-nginx</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2022-09-29T07:32:22+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/juming-nginx/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;juming-nginx&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>&quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/juming-nginx/_data&quot;</code>，这是挂载点路径。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# sudo su root</span><br><span class="line">[root@localhost /]# cd /var/lib/docker</span><br><span class="line">[root@localhost docker]# ls</span><br><span class="line">buildkit    image    overlay2  runtimes  tmp    volumes</span><br><span class="line">containers  network  plugins   swarm     trust</span><br><span class="line">[root@localhost docker]# cd volumes/</span><br><span class="line">[root@localhost volumes]# ls</span><br><span class="line">54ad8998dec11b6869c177a82fac32b058ca7d9974b3317b521a29068cd7d48b  juming-nginx</span><br><span class="line">6cc337c3651f9e8bc17049993376615a8105e70b1db727c98aa9f74e4cc176a8  metadata.db</span><br><span class="line">backingFsBlockDev</span><br><span class="line">[root@localhost volumes]# cd juming-nginx/</span><br><span class="line">[root@localhost juming-nginx]# ls</span><br><span class="line">_data</span><br><span class="line">[root@localhost juming-nginx]# cd _data/</span><br><span class="line">[root@localhost _data]# ls</span><br><span class="line">conf.d          mime.types  nginx.conf   uwsgi_params</span><br><span class="line">fastcgi_params  modules     scgi_params</span><br></pre></td></tr></table></figure><p>查看容器内的目录，内容与外部挂载点的内容一致。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost _data]# docker exec -it nginx02 /bin/bash</span><br><span class="line">root@88dfccc5a568:/# cd /etc/nginx</span><br><span class="line">root@88dfccc5a568:/etc/nginx# ls</span><br><span class="line">conf.d		mime.types  nginx.conf	 uwsgi_params</span><br><span class="line">fastcgi_params	modules     scgi_params</span><br></pre></td></tr></table></figure><p>所有docker容器内的卷，没有指定目录的情况下都是在 <code>/var/lib/docker/volumes/xxx/_data</code> 目录下。通过具名挂载可以方便的找到数据卷。</p><ul><li>-v 容器内路径 # 匿名挂载</li><li>-v 卷名:容器内路径 # 具名挂载</li><li>-v &#x2F;宿主机路径:容器内路径 # 指定路径挂载</li></ul><p>通过 <code>-v 容器内路径:ro/rw</code> 改变读写权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ro readonly  只读</span><br><span class="line">rw readwrite  读写</span><br></pre></td></tr></table></figure><p>:ro 与 :rw ，使用格式如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -P --name nginx03 -v juming-nginx:/etc/nginx:ro nginx</span><br><span class="line">sudo docker run -d -P --name nginx03 -v juming-nginx:/etc/nginx:rw nginx</span><br></pre></td></tr></table></figure><p>ro 说明这个路径只能通过宿主机来操作，容器内部无法操作<br>默认情况下是 rw，容器内外，可读可写</p><h3 id="初识-Dockerfile"><a href="#初识-Dockerfile" class="headerlink" title="初识 Dockerfile"></a>初识 Dockerfile</h3><p>Dockerfile是用来构建Docker镜像的文件，可以理解为命令参数脚本。通过这个脚本可以生成镜像，镜像是一层一层的，而脚本的一个个命令，每个命令就是一层。这里简单使用 dockerfile 做一个挂载测试。</p><p>在 dockerfile 中，可以使用命令挂载，它和命令行中指定参数挂载类似。</p><p>在指定目录内创建一个 dockerfile 文件，名字可以随机，建议 Dockerfile</p><p>文件中的内容： 指令（大写）+ 参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ mkdir docker-test-volume</span><br><span class="line">[chyris@localhost ~]$ ls</span><br><span class="line">100  --add-repo  docker-test-volume  公共  模板  视频  图片  文档  下载  音乐  桌面</span><br><span class="line">[chyris@localhost ~]$ pwd</span><br><span class="line">/home/chyris</span><br><span class="line">[chyris@localhost ~]$ cd docker-test-volume/</span><br><span class="line">[chyris@localhost docker-test-volume]$ pwd</span><br><span class="line">/home/chyris/docker-test-volume</span><br><span class="line">[chyris@localhost docker-test-volume]$ vim dockerfile01</span><br><span class="line">[chyris@localhost docker-test-volume]$ cat dockerfile01 </span><br><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]</span><br><span class="line"></span><br><span class="line">CMD echo &quot;---end---&quot;</span><br><span class="line">CMD /bin/bash</span><br></pre></td></tr></table></figure><p>使用 <code>docker build</code> 命令创建镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost docker-test-volume]$ sudo docker build -f /home/chyris/docker-test-volume/dockerfile01 -t chyris/centos:1.0 .</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/4 : FROM centos</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">5d0da3dc9764</span></span><br><span class="line">Step 2/4 : VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Using cache</span></span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">cf9203868e17</span></span><br><span class="line">Step 3/4 : CMD echo &quot;---end---&quot;</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Using cache</span></span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">0d04fe1b5ef0</span></span><br><span class="line">Step 4/4 : CMD /bin/bash</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Using cache</span></span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">dbe6e49f71a1</span></span><br><span class="line">Successfully built dbe6e49f71a1</span><br><span class="line">Successfully tagged chyris/centos:1.0</span><br><span class="line">[chyris@localhost docker-test-volume]$ sudo docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">chyris/centos         1.0       dbe6e49f71a1   59 seconds ago   231MB</span><br><span class="line">chyris/centos         latest    dbe6e49f71a1   59 seconds ago   231MB</span><br></pre></td></tr></table></figure><p>启动自己生成的镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost docker-test-volume]$ sudo docker run -it chyris/centos:1.0 /bin/bash</span><br><span class="line">[root@ca9f817d2c76 /]# ls -l</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 360 Sep 29 18:05 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Sep 29 18:05 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root   9 Nov  3  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwx------.   2 root root   6 Sep 15  2021 lost+found</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 media</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 mnt</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 opt</span><br><span class="line">dr-xr-xr-x. 238 root root   0 Sep 29 18:05 proc</span><br><span class="line">dr-xr-x---.   2 root root 162 Sep 15  2021 root</span><br><span class="line">drwxr-xr-x.  11 root root 163 Sep 15  2021 run</span><br><span class="line">lrwxrwxrwx.   1 root root   8 Nov  3  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 srv</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Sep 29 14:47 sys</span><br><span class="line">drwxrwxrwt.   7 root root 171 Sep 15  2021 tmp</span><br><span class="line">drwxr-xr-x.  12 root root 144 Sep 15  2021 usr</span><br><span class="line">drwxr-xr-x.  20 root root 262 Sep 15  2021 var</span><br><span class="line">drwxr-xr-x.   2 root root   6 Sep 29 18:05 volume01</span><br><span class="line">drwxr-xr-x.   2 root root   6 Sep 29 18:05 volume02</span><br></pre></td></tr></table></figure><p><code>volume01</code> 和 <code>volume02</code> 这两个目录就是生成镜像的时候自动挂载的数据卷目录。</p><p>这个卷的目录和外部一定有一个同步的目录，这个外部的挂载点是匿名的</p><p>在容器内部的 <code>volume01</code> 目录创建一个 <code>test.txt</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ca9f817d2c76 /]# cd volume01</span><br><span class="line">[root@ca9f817d2c76 volume01]# touch test.txt</span><br></pre></td></tr></table></figure><p>此时容器处于运行状态，在主机中通过容器 id 查看这个容器的信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker inspect ca9f817d2c76</span><br></pre></td></tr></table></figure><p>可以看到容器内外的数据卷挂载情况。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;9d753e3e6954106a630a5f09a084bd8d26625724f263928416cb2f8134165c2e&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/9d753e3e6954106a630a5f09a084bd8d26625724f263928416cb2f8134165c2e/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume02&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;7d56bcb248b6b0c9ad54631e1183dd91f58435471d068697c04ba02930de1d48&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/7d56bcb248b6b0c9ad54631e1183dd91f58435471d068697c04ba02930de1d48/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume01&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>通过 dockerfile 生成的镜像，声明了 <code>volume01</code> 和 <code>volume02</code> 这两个目录就是容器内的挂载点，对应容器外的特定路径下的挂载点，并且在路径中使用了随机字符串，这就是匿名挂载。</p><p><code>volume01</code> 对应的主机挂载点路径为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/volumes/7d56bcb248b6b0c9ad54631e1183dd91f58435471d068697c04ba02930de1d48/_data</span><br></pre></td></tr></table></figure><p>查看该路径下是否存在 <code>test.txt</code> 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo ls -l /var/lib/docker/volumes/7d56bcb248b6b0c9ad54631e1183dd91f58435471d068697c04ba02930de1d48/_data</span><br><span class="line">总用量 0</span><br><span class="line">-rw-r--r--. 1 root root 0 9月  30 02:10 test.txt</span><br></pre></td></tr></table></figure><p>数据已经同步</p><p>通常情况下，我们使用 dockerfile 自己构建镜像，如果构建镜像的时候没有挂载卷，可以通过 <code>-v 卷名:容器内路径</code>手动挂载（具名），当然也可以是其它方式挂载。</p><h3 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h3><h4 id="容器间同步"><a href="#容器间同步" class="headerlink" title="容器间同步"></a>容器间同步</h4><p>多个容器间同步数据，可以使用 <code>--volumes-from</code> 实现。</p><p>启动一个容器 <code>docker01</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -it --name docker01 chyris/centos:1.0</span><br><span class="line">[root@c1cd56ed7181 /]# ls</span><br><span class="line">bin  etc   lib	  lost+found  mnt  proc  run   srv  tmp  var	   volume02</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr  volume01</span><br><span class="line">[root@c1cd56ed7181 /]# </span><br></pre></td></tr></table></figure><p>使用 <code>ctrl+P+Q</code> 退出这个容器而不停止它，使用 <code>--volumes-from</code> 对一个新的容器进行挂载。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@c1cd56ed7181 /]# [chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE               COMMAND                  CREATED              STATUS              PORTS     NAMES</span><br><span class="line">c1cd56ed7181   chyris/centos:1.0   &quot;/bin/sh -c /bin/bash&quot;   About a minute ago   Up About a minute             docker01</span><br><span class="line">[chyris@localhost ~]$ sudo docker run -it --name docker02 --volumes-from docker01 chyris/centos:1.0</span><br><span class="line">[root@dbc6666e5004 /]# ls</span><br><span class="line">bin  etc   lib	  lost+found  mnt  proc  run   srv  tmp  var	   volume02</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr  volume01</span><br></pre></td></tr></table></figure><p>可以看到数据卷已经同步</p><p>在 docker02 容器中的 volume01 新建一个 <code>test.js</code> 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dbc6666e5004 /]# touch volume01/test.js</span><br><span class="line">[root@dbc6666e5004 /]# ls volume01</span><br><span class="line">test.js</span><br></pre></td></tr></table></figure><p>查看 docker01 容器对应目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker attach docker01</span><br><span class="line">[root@c1cd56ed7181 /]# ls volume01</span><br><span class="line">test.js</span><br></pre></td></tr></table></figure><p>docker01 容器中存在 <code>test.js</code> 文件，容器间数据同步完成。</p><p>在 docker02 主机新建一个目录 test</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@dbc6666e5004 /]# touch test</span><br><span class="line">[root@dbc6666e5004 /]# ls</span><br><span class="line">bin  etc   lib	  lost+found  mnt  proc  run   srv  test  usr  volume01</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  tmp   var  volume02</span><br></pre></td></tr></table></figure><p>在 docker01 主机查看对应目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@c1cd56ed7181 /]# ls                        </span><br><span class="line">bin  etc   lib	  lost+found  mnt  proc  run   srv  tmp  var	   volume02</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr  volume01</span><br></pre></td></tr></table></figure><p>并无此目录，说明对非挂载目录，容器间数据并不会同步。</p><p>如果继续使用 <code>sudo docker run -it --name docker03 --volumes-from docker01 chyris/centos:1.0</code> 进行挂载，效果同上。</p><p>此时所有运行的容器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE               COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">4b4fecf8e45c   chyris/centos:1.0   &quot;/bin/sh -c /bin/bash&quot;   28 seconds ago   Up 28 seconds             docker03</span><br><span class="line">dbc6666e5004   chyris/centos:1.0   &quot;/bin/sh -c /bin/bash&quot;   30 minutes ago   Up 30 minutes             docker02</span><br><span class="line">c1cd56ed7181   chyris/centos:1.0   &quot;/bin/sh -c /bin/bash&quot;   33 minutes ago   Up 33 minutes             docker01</span><br></pre></td></tr></table></figure><p>如果此时将 docker01 停止并删除，那么 docker02，docker03 中的挂载点会依旧存在并正常使用。</p><p>使用 <code>sudo docker inspect docker03</code> 命令查看 docker03 容器详情</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume01&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;54fcebc684861361b345a680236b310dd1d113cb76020fe243b35b3510e6988d&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/54fcebc684861361b345a680236b310dd1d113cb76020fe243b35b3510e6988d/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume02&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>使用 <code>sudo docker inspect docker02</code> 命令查看 docker02 容器详情</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume01&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;54fcebc684861361b345a680236b310dd1d113cb76020fe243b35b3510e6988d&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/54fcebc684861361b345a680236b310dd1d113cb76020fe243b35b3510e6988d/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume02&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>使用 <code>sudo docker inspect docker01</code> 命令查看 docker01 容器详情</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume01&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;54fcebc684861361b345a680236b310dd1d113cb76020fe243b35b3510e6988d&quot;,</span><br><span class="line">        &quot;Source&quot;: &quot;/var/lib/docker/volumes/54fcebc684861361b345a680236b310dd1d113cb76020fe243b35b3510e6988d/_data&quot;,</span><br><span class="line">        &quot;Destination&quot;: &quot;volume02&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">        &quot;RW&quot;: true,</span><br><span class="line">        &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>查看三个容器 volume01 挂载，挂载到宿主机目录一致。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker03:&quot;Source&quot;: &quot;/var/lib/docker/volumes/f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4/_data&quot;,</span><br><span class="line"></span><br><span class="line">docker02:&quot;Source&quot;: &quot;/var/lib/docker/volumes/f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4/_data&quot;,</span><br><span class="line"></span><br><span class="line">docker01:&quot;Source&quot;: &quot;/var/lib/docker/volumes/f04225fca3df77ec12c971ca56ec7f4dca0166098729cf64810f141d6deb9fe4/_data&quot;,</span><br></pre></td></tr></table></figure><p>在容器间实现数据卷拷贝，但是本质都是挂载到了宿主机上的同一位置。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/copy.png" title="This is an 数据卷容器copy image"><p>其实三个容器都挂载了宿主机上的 volume，数据都在 <code>/var/lib/docker/volumes/xxx/_data</code> 里面。</p><p>数据卷容器的生命周期会一直持续到没有容器使用为止，但是一旦持久化到本地，本地的数据是不会删除的。</p><h4 id="mysql-数据共享"><a href="#mysql-数据共享" class="headerlink" title="mysql 数据共享"></a>mysql 数据共享</h4><p>多个mysql实现数据共享，使用以下方式：</p><p>容器 mysql01</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -p 3307:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root --name mysql01 mysql:5.7</span><br></pre></td></tr></table></figure><p>如果使用匿名挂载，上述命令可以简化为：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -p 3307:3306 -v /etc/mysql/conf.d -v /var/lib/mysql -e MYSQL_ROOT_PASSWORD=root --name mysql01 mysql:5.7</span><br></pre></td></tr></table></figure><p>容器 mysql02</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root --name mysql02 --volumes-from mysql01 mysql:5.7</span><br></pre></td></tr></table></figure><p>上述操作完成，可以实现两个容器间数据同步。</p><p>port is already allocated.</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>容器之间配置信息的传递，数据卷容器的生命同期一直持续到没有容器使用为止。但是一旦持久化到了本地，这个时候，本地的数据是不会删除的！</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8.png" title="This is an 数据卷容器 image"><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><h3 id="Dockerfile-介绍"><a href="#Dockerfile-介绍" class="headerlink" title="Dockerfile 介绍"></a>Dockerfile 介绍</h3><p>Dockerfile 是用来构建Docker镜像的文件，可以理解为命令参数脚本。</p><p>Dockerfile 构建步骤：</p><ol><li>编写一个dockerfile文件</li><li>docker build 构建成为一个镜像</li><li>docker run运行镜像</li><li>docker push发布镜像（DockerHub镜像仓库、阿里云镜像仓库）</li></ol><p>可以在 dockerhub 中查看镜像的 dockerfile ，例如centos7的dockerfile。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">ADD centos-7-x86_64-docker.tar.xz /</span><br><span class="line"></span><br><span class="line">LABEL \</span><br><span class="line">    org.label-schema.schema-version=&quot;1.0&quot; \</span><br><span class="line">    org.label-schema.name=&quot;CentOS Base Image&quot; \</span><br><span class="line">    org.label-schema.vendor=&quot;CentOS&quot; \</span><br><span class="line">    org.label-schema.license=&quot;GPLv2&quot; \</span><br><span class="line">    org.label-schema.build-date=&quot;20201113&quot; \</span><br><span class="line">    org.opencontainers.image.title=&quot;CentOS Base Image&quot; \</span><br><span class="line">    org.opencontainers.image.vendor=&quot;CentOS&quot; \</span><br><span class="line">    org.opencontainers.image.licenses=&quot;GPL-2.0-only&quot; \</span><br><span class="line">    org.opencontainers.image.created=&quot;2020-11-13 00:00:00+00:00&quot;</span><br><span class="line"></span><br><span class="line">CMD [&quot;/bin/bash&quot;]</span><br></pre></td></tr></table></figure><h3 id="Dockerfile-构建过程"><a href="#Dockerfile-构建过程" class="headerlink" title="Dockerfile 构建过程"></a>Dockerfile 构建过程</h3><h4 id="内容基础知识"><a href="#内容基础知识" class="headerlink" title="内容基础知识"></a>内容基础知识</h4><p>每个指令都必须是大写字母。</p><p>按照从上到下顺序执行。</p><p># 表示注释。</p><p>每一条指令都会创建一个新的镜像层并提交。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile00.png" title="This is an dockerfile00 image"><p>dockerfile是面向开发的，要发布项目，做镜像，就需要编写dockerfile文件。</p><h4 id="执行DockerFile大致流程"><a href="#执行DockerFile大致流程" class="headerlink" title="执行DockerFile大致流程"></a>执行DockerFile大致流程</h4><ol><li>docker从基础镜像运行一个容器</li><li>执行一条指令并对容器作出修改</li><li>执行类似docker commit的操作提交一个新的镜像层</li><li>docker再基于刚提交的镜像运行一个新容器</li><li>执行dockerfile中的下一条指令直到所有指令都执行完成</li></ol><h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>从应用软件的角度来看，DockerFile、Docker镜像与Docker容器分别代表软件的三个阶段。</p><ul><li>DockerFile是软件的原材料</li><li>Docker镜像是软件的交付品</li><li>Docker容器可以认为是软件的运行态</li></ul><p>DockerFile面向开发，Docker镜像成为交付标准，Docker容器则涉及部署和运维，三者缺一不可，合力充当Docker体系的基石。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile01.png" title="This is an dockerfile01 image"><p>DockerFile：构建文件，定义了一切的步骤，源代码。Dockerfile涉及的内容包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进程和内核进程(当应用进程需要和系统服务和内核进程打交道，这时需要考虑如何设计namespace的权限控制)等等;</p><p>Docker镜像：通过DockerFile文件构建（docker build）生成的镜像，是最终发布和运行的产品。</p><p>Docker容器：容器就是镜像运行起来提供服务的。</p><h3 id="DockerFile指令"><a href="#DockerFile指令" class="headerlink" title="DockerFile指令"></a>DockerFile指令</h3><h4 id="所有指令"><a href="#所有指令" class="headerlink" title="所有指令"></a>所有指令</h4><p>先查看一个比较全面的解释。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile02.png" title="This is an dockerfile02 image"><p>下面来做一个比较详细的总结。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FROM：基础镜像，一切从这里开始构建，比如 centos。</span><br><span class="line"></span><br><span class="line">MAINTAINER：镜像是谁写的：姓名+邮箱，建议以此格式：姓名&lt;邮箱&gt;。</span><br><span class="line"></span><br><span class="line">RUN：镜像构建的时候需要运行的命令</span><br><span class="line"></span><br><span class="line">ADD：添加内容，比如添加一个 tomcat 压缩包。</span><br><span class="line"></span><br><span class="line">WORKDIR：镜像的工作目录。</span><br><span class="line"></span><br><span class="line">VOLUME：挂载的目录</span><br><span class="line"></span><br><span class="line">EXPOSE：指定暴露端口，跟 -p 一个道理（这里只是声明端口，run的时候还是要使用 -p 的，而 -P 会默认指定的就是EXPOSE的端口）。</span><br><span class="line"></span><br><span class="line">RUN：最终要运行的。</span><br><span class="line"></span><br><span class="line">CMD：指定这个容器启动的时候要运行的命令，只有最后一个会生效，可被替代。</span><br><span class="line"></span><br><span class="line">ENTRYPOINT：指定这个容器启动的时候要运行的命令，可以追加命令。</span><br><span class="line"></span><br><span class="line">ONBUILD：当构建一个被继承DockerFile这个时候就会运行ONBUILD的指令。触发指令。</span><br><span class="line"></span><br><span class="line">COPY：类似ADD，将文件拷贝到镜像中。</span><br><span class="line"></span><br><span class="line">ENV：构建的时候设置环境变量。</span><br></pre></td></tr></table></figure><p>下面是比较通俗一点的解释，便于理解，还是要实际操作才能真正理解。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/dockerfile03.png" title="This is an dockerfile03 image"><h4 id="CMD和ENTRYPOINT"><a href="#CMD和ENTRYPOINT" class="headerlink" title="CMD和ENTRYPOINT"></a>CMD和ENTRYPOINT</h4><ul><li>CMD # 指定这个容器启动的时候要运行的命令，只有最后一个会生效，可被替代</li><li>ENTRYPOINT # 指定这个容器启动的时候要运行的命令，可以追加命令</li></ul><p>测试CMD</p><p>编写dockerfile文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ cd idocker-images/</span><br><span class="line">[chyris@localhost idocker-images]$ ls</span><br><span class="line">idockerfile-centos</span><br><span class="line">[chyris@localhost idocker-images]$ vim idockerfile-cmd-test</span><br><span class="line">[chyris@localhost idocker-images]$ cat idockerfile-cmd-test </span><br><span class="line">FROM centos</span><br><span class="line">CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br></pre></td></tr></table></figure><p>构建镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker build -f idockerfile-cmd-test  -t cmdtest .</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/2 : FROM centos</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">5d0da3dc9764</span></span><br><span class="line">Step 2/2 : CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 4ee475815659</span></span><br><span class="line">Removing intermediate container 4ee475815659</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">5f42b0119e14</span></span><br><span class="line">Successfully built 5f42b0119e14</span><br><span class="line">Successfully tagged cmdtest:latest</span><br></pre></td></tr></table></figure><p>run运行，<code>ls -a</code> 命令生效、执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker run 5f42b0119e14</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>追加一个命令 <code>-l</code> ,构成 <code>ls -al</code> 命令，发现报错</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker run 5f42b0119e14 -l</span><br><span class="line">ERRO[0001] error waiting for container: context canceled </span><br><span class="line">docker: Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: &quot;-l&quot;: executable file not found in $PATH: unknown.</span><br></pre></td></tr></table></figure><p>使用CMD命令的情况下，<code>-l</code> 替换了 <code>CMD [&quot;1s&quot;，&quot;-a&quot;]</code> 命令，因为 <code>-l</code> 不是命令，所以报错。下面的情况便是完整替换。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker run 5f42b0119e14 ls -al</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Sep 30 05:17 .</span><br><span class="line">drwxr-xr-x.   1 root root   6 Sep 30 05:17 ..</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Sep 30 05:17 .dockerenv</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 340 Sep 30 05:17 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Sep 30 05:17 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>测试ENTRYPOINT</p><p>编写dockerfile文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ ls</span><br><span class="line">idockerfile-centos  idockerfile-cmd-test</span><br><span class="line">[chyris@localhost idocker-images]$ vim idockerfile-entrypoint-test</span><br><span class="line">[chyris@localhost idocker-images]$ cat idockerfile-entrypoint-test </span><br><span class="line">FROM centos</span><br><span class="line">ENTRYPOINT [&quot;ls&quot;,&quot;-a&quot;]</span><br></pre></td></tr></table></figure><p>构建镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker build -f idockerfile-entrypoint-test -t entrypoint-test .</span><br><span class="line">Sending build context to Docker daemon  4.096kB</span><br><span class="line">Step 1/2 : FROM centos</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">5d0da3dc9764</span></span><br><span class="line">Step 2/2 : ENTRYPOINT [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> dea5d81d0ac1</span></span><br><span class="line">Removing intermediate container dea5d81d0ac1</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">7e34c9c14d15</span></span><br><span class="line">Successfully built 7e34c9c14d15</span><br><span class="line">Successfully tagged entrypoint-test:latest</span><br></pre></td></tr></table></figure><p>run运行，<code>ls -a</code> 命令生效、执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker run 7e34c9c14d15</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>追加一个命令 <code>-l</code> ,构成 <code>ls -al</code> 命令，结果正常执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker run 7e34c9c14d15 -l</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Sep 30 05:23 .</span><br><span class="line">drwxr-xr-x.   1 root root   6 Sep 30 05:23 ..</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Sep 30 05:23 .dockerenv</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 340 Sep 30 05:23 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Sep 30 05:23 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ENTRYPOINT命令的情况下，<code>-l</code> 追加在 <code>ENTRYPOINT [&quot;1s&quot;，&quot;-a&quot;]</code> 命令后面，得到 <code>ls -al</code> 的命令，所以命令正常执行（追加的命令，是直接拼接在 <code>ENTRYPOINT</code> 命令的后面）</p><h3 id="自定义centos镜像"><a href="#自定义centos镜像" class="headerlink" title="自定义centos镜像"></a>自定义centos镜像</h3><p>在Docker Hub中，99%镜像都是来自scratch这个基础镜像，然后设置需要的软件和配置来进行的构建。下面这个示例就是最基础的镜像构建过程，我们一般自定义centos都是在发行版的centos基础上进行构建，而对于mysql之类的其它软件镜像，它们的底层构建中已经包含了这个过程，我们直接使用即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">ADD centos-7-x86_64-docker.tar.xz /</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>编写dockerfile的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER chyris&lt;chyris@qq.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD echo $MYPATH</span><br><span class="line">CMD echo &quot;---end---&quot;</span><br><span class="line">CMD /bin/bash</span><br></pre></td></tr></table></figure><p>在自定义创建的目录 <code>idocker-images</code> 中创建 <code>idockerfile-centos</code> 文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ls</span><br><span class="line">100  --add-repo  docker-test-volume  公共  模板  视频  图片  文档  下载  音乐  桌面</span><br><span class="line">[chyris@localhost ~]$ pwd</span><br><span class="line">/home/chyris</span><br><span class="line">[chyris@localhost ~]$ mkdir idocker-images</span><br><span class="line">[chyris@localhost ~]$ cd idocker-images/</span><br><span class="line">[chyris@localhost idocker-images]$ ls</span><br><span class="line">[chyris@localhost idocker-images]$ vim idockerfile-centos</span><br><span class="line">[chyris@localhost idocker-images]$ cat idockerfile-centos</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>通过文件 <code>idockerfile-centos</code> 构建镜像</p><p>使用命令：<code>docker build -f dockerfile文件路径 -t 镜像名:[tag] .</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker build -f idockerfile-centos -t mycentos:1.0 .</span><br><span class="line">...</span><br><span class="line">Successfully built f7c315a3fb4f</span><br><span class="line">Successfully tagged mycentos:1.0</span><br></pre></td></tr></table></figure><p>最后测试运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mycentos              1.0       f7c315a3fb4f   8 minutes ago   625MB</span><br><span class="line">[chyris@localhost idocker-images]$ sudo docker run -it mycentos:1.0</span><br><span class="line">[root@fdff46c29424 local]# pwd</span><br><span class="line">/usr/local</span><br><span class="line">[root@fdff46c29424 local]# ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500 ...</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536 ...</span><br><span class="line"></span><br><span class="line">[root@fdff46c29424 local]# vim</span><br></pre></td></tr></table></figure><p>默认工作目录是：<code>/usr/local</code>，<code>ifconfig</code> 和 <code>vim</code> 命令都可以使用。</p><p>对比原始 <code>centos:7</code> 镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -it centos:7</span><br><span class="line">[sudo] chyris 的密码：</span><br><span class="line">[root@5381ecfd38a9 /]# pwd</span><br><span class="line">/</span><br><span class="line">[root@5381ecfd38a9 /]# vim</span><br><span class="line">bash: vim: command not found</span><br><span class="line">[root@5381ecfd38a9 /]# ifconfig</span><br><span class="line">bash: ifconfig: command not found</span><br><span class="line">[root@5381ecfd38a9 /]# exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p>原始的 <code>centos:7</code> 的工作目录是 <code>/</code>，<code>ifconfig</code> 和 <code>vim</code> 命令都不可用。</p><p>列出自定义镜像历史构建过程。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost idocker-images]$ sudo docker history mycentos:1.0</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">f7c315a3fb4f   24 minutes ago   /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/bin…   0B        </span><br><span class="line">c5b9092c17b8   24 minutes ago   /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echo…   0B        </span><br><span class="line">33065086697c   24 minutes ago   /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echo…   0B        </span><br><span class="line">01746234c9d2   24 minutes ago   /bin/sh -c #(nop)  EXPOSE 80                    0B        </span><br><span class="line">09d4e0472eb8   24 minutes ago   /bin/sh -c yum -y install net-tools             183MB     </span><br><span class="line">5ff062bb5012   24 minutes ago   /bin/sh -c yum -y install vim                   238MB     </span><br><span class="line">49c162133a57   28 minutes ago   /bin/sh -c #(nop) WORKDIR /usr/local            0B        </span><br><span class="line">72b68d846877   28 minutes ago   /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0B        </span><br><span class="line">cbfe1c2dc71e   28 minutes ago   /bin/sh -c #(nop)  MAINTAINER chyris&lt;chyris@…   0B        </span><br><span class="line">eeb6ee3f44bd   12 months ago    /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span><br><span class="line">&lt;missing&gt;      12 months ago    /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span><br><span class="line">&lt;missing&gt;      12 months ago    /bin/sh -c #(nop) ADD file:b3ebbe8bd304723d4…   204MB</span><br></pre></td></tr></table></figure><h3 id="自定义tomcat镜像"><a href="#自定义tomcat镜像" class="headerlink" title="自定义tomcat镜像"></a>自定义tomcat镜像</h3><p>准备镜像文件：tomcat压缩包，jdk的压缩包。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ pwd</span><br><span class="line">/home/chyris/build/tomcat</span><br><span class="line">[chyris@localhost tomcat]$ touch readme.txt</span><br><span class="line">[chyris@localhost tomcat]$ ls</span><br><span class="line">apache-tomcat-8.5.82.tar.gz  jdk-8u202-linux-x64.tar.gz  readme.txt</span><br></pre></td></tr></table></figure><p>编写 Dockerfile 文件，官方命名 Dockerfile，build 会自动寻找这个文件，就不需要 <code>-f</code> 指定文件名了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER chyris&lt;chyris@qq.com&gt;</span><br><span class="line"></span><br><span class="line">COPY readme.txt /usr/local/readme.txt</span><br><span class="line"></span><br><span class="line">ADD jdk-8u202-linux-x64.tar.gz /usr/local/</span><br><span class="line"></span><br><span class="line">ADD apache-tomcat-8.5.82.tar.gz /usr/local/</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line"></span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_202</span><br><span class="line">ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"></span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.82</span><br><span class="line">ENV CATALINA_BASE /usr/local/apache-tomcat-8.5.82</span><br><span class="line"></span><br><span class="line">ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">CMD /usr/local/apache-tomcat-8.5.82/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-8.5.82/logs/catalina.out</span><br></pre></td></tr></table></figure><p>将上述内容写入Dockerfile文件即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ vim Dockerfile</span><br><span class="line">[chyris@localhost tomcat]$ ls </span><br><span class="line">apache-tomcat-8.5.82.tar.gz  Dockerfile  jdk-8u202-linux-x64.tar.gz  readme.txt</span><br><span class="line">[chyris@localhost tomcat]$ cat Dockerfile </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>构建镜像</p><ul><li>-f：指定要使用的Dockerfile路径，命名为 Dockerfile 时，build 会自动在当前目录寻找这个文件，此时不需要 <code>-f</code> 指定文件名</li><li>-t: 镜像的名字及标签，通常name:tag或者name格式</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chyris@localhost tomcat]$ sudo docker build -t itomcat .</span><br><span class="line">...</span><br><span class="line">uccessfully built 7f3c9bb3a621</span><br><span class="line">Successfully tagged itomcat:latest</span><br><span class="line">[chyris@localhost tomcat]$ sudo docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">itomcat               latest    7f3c9bb3a621   17 minutes ago   859MB</span><br></pre></td></tr></table></figure><p>启动镜像</p><p>使用交互命令查看 <code>webapps</code> 目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker run -it itomcat /bin/bash</span><br><span class="line">[root@edfb29def139 ~]# pwd</span><br><span class="line">/root</span><br><span class="line">[root@edfb29def139 ~]# cd /usr/local/apache-tomcat-8.5.82/</span><br><span class="line">[root@edfb29def139 apache-tomcat-8.5.82]# ls</span><br><span class="line">BUILDING.txt     LICENSE  README.md      RUNNING.txt  conf  logs  webapps</span><br><span class="line">CONTRIBUTING.md  NOTICE   RELEASE-NOTES  bin          lib   temp  work</span><br><span class="line">[root@1a772707821c apache-tomcat-8.5.82]# ls logs</span><br><span class="line">[root@edfb29def139 apache-tomcat-8.5.82]# cd webapps/</span><br><span class="line">[root@edfb29def139 webapps]# ls</span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">[root@edfb29def139 webapps]# exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p>然后启动镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker run -d -p 8081:8080 --name chyris-tomcat -v /home/chyris/build/tomcat/test:/usr/local/apache-tomcat-8.5.82/webapps/test -v /home/chyris/build/tomcat/tomcat-logs/:/usr/local/apache-tomcat-8.5.82/logs itomcat</span><br><span class="line">d00c06bae7e77885d517f7bee6d99dc2b0489d1ce16e97403bb97e9ff1db337e</span><br><span class="line">[chyris@localhost tomcat]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS         PORTS                                       NAMES</span><br><span class="line">d00c06bae7e7   itomcat   &quot;/bin/sh -c &#x27;/usr/lo…&quot;   10 seconds ago   Up 9 seconds   0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   chyris-tomcat</span><br></pre></td></tr></table></figure><p>查看宿主机挂载：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ ls</span><br><span class="line">apache-tomcat-8.5.82         jdk-8u202-linux-x64.tar.gz  tomcat-logs</span><br><span class="line">apache-tomcat-8.5.82.tar.gz  readme.txt</span><br><span class="line">Dockerfile                   test</span><br><span class="line">[chyris@localhost tomcat]$ ls tomcat-logs/</span><br><span class="line">catalina.2022-09-30.log      localhost.2022-09-30.log</span><br><span class="line">catalina.out                 localhost_access_log.2022-09-30.txt</span><br><span class="line">host-manager.2022-09-30.log  manager.2022-09-30.log</span><br><span class="line">[chyris@localhost tomcat]$ ls test/</span><br></pre></td></tr></table></figure><p>查看容器内工作目录和挂载：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker exec -it d00c06bae7e7 /bin/bash</span><br><span class="line">[root@d00c06bae7e7 local]# pwd</span><br><span class="line">/usr/local</span><br><span class="line">[root@d00c06bae7e7 local]# cd apache-tomcat-8.5.82/</span><br><span class="line">[root@d00c06bae7e7 apache-tomcat-8.5.82]# ls</span><br><span class="line">BUILDING.txt     LICENSE  README.md      RUNNING.txt  conf  logs  webapps</span><br><span class="line">CONTRIBUTING.md  NOTICE   RELEASE-NOTES  bin          lib   temp  work</span><br><span class="line">[root@d00c06bae7e7 apache-tomcat-8.5.82]# ls logs</span><br><span class="line">catalina.2022-09-30.log  host-manager.2022-09-30.log  localhost_access_log.2022-09-30.txt</span><br><span class="line">catalina.out             localhost.2022-09-30.log     manager.2022-09-30.log</span><br><span class="line">[root@d00c06bae7e7 apache-tomcat-8.5.82]# ls webapps</span><br><span class="line">ROOT  docs  examples  host-manager  manager  test</span><br></pre></td></tr></table></figure><p>访问测试</p><p>宿主机使用 <code>curl</code> 命令访问</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8081</span><br></pre></td></tr></table></figure><p>外部主机访问：<a target="_blank" rel="noopener" href="http://192.168.0.105:8081/">http://192.168.0.105:8081</a></p><p>发布项目</p><p>由于做了卷挂载，直接在本地test文件夹下编写项目就可以发布</p><p>在 <code>/home/chyris/build/tomcat/test</code> 目录下，创建 <code>WEB-INF/web.xml</code> 和 <code>index.jsp</code> 目录结构。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ cd test/</span><br><span class="line">[chyris@localhost test]$ ls</span><br><span class="line">[chyris@localhost test]$ sudo mkdir WEB-INF</span><br><span class="line">[chyris@localhost test]$ cd WEB-INF/</span><br><span class="line">[chyris@localhost WEB-INF]$ sudo vim web.xml</span><br><span class="line">[chyris@localhost WEB-INF]$ cd ..</span><br><span class="line">[chyris@localhost test]$ ls</span><br><span class="line">WEB-INF</span><br><span class="line">[chyris@localhost test]$ vim index.jsp</span><br><span class="line">[chyris@localhost test]$ sudo vim index.jsp</span><br><span class="line">[chyris@localhost test]$ pwd</span><br><span class="line">/home/chyris/build/tomcat/test</span><br></pre></td></tr></table></figure><p>其中 <code>web.xml</code> 中的内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee  http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">version</span>=<span class="string">&quot;2.5&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>index.jsp</code> 中的内容</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line"> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;hello,sywl&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">Hello World!&lt;br/&gt;</span><br><span class="line">&lt;%</span><br><span class="line">System.out.println(<span class="string">&quot;*** my web test ***&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>项目部署成功，可以在本地使用：<code>http://192.168.0.105:8081/text</code> 访问。</p><p>查看日志文件 <code>tomcat/tomcat-logs/catalina.out</code> 内容。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ ls</span><br><span class="line">apache-tomcat-8.5.82         Dockerfile                  readme.txt  tomcat-logs</span><br><span class="line">apache-tomcat-8.5.82.tar.gz  jdk-8u202-linux-x64.tar.gz  test</span><br><span class="line">[chyris@localhost tomcat]$ ll tomcat-logs/</span><br><span class="line">总用量 40</span><br><span class="line">-rw-r-----. 1 root root 13456 10月  1 02:10 catalina.2022-09-30.log</span><br><span class="line">-rw-r-----. 1 root root 13495 10月  1 02:21 catalina.out</span><br><span class="line">-rw-r-----. 1 root root     0 10月  1 01:08 host-manager.2022-09-30.log</span><br><span class="line">-rw-r-----. 1 root root   918 10月  1 01:58 localhost.2022-09-30.log</span><br><span class="line">-rw-r-----. 1 root root  1774 10月  1 02:21 localhost_access_log.2022-09-30.txt</span><br><span class="line">-rw-r-----. 1 root root     0 10月  1 01:08 manager.2022-09-30.log</span><br><span class="line">[chyris@localhost tomcat]$ sudo cat tomcat-logs/catalina.out</span><br><span class="line">30-Sep-2022 17:08:08.313 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version name:   Apache Tomcat/8.5.82</span><br><span class="line">...</span><br><span class="line">----my web test----</span><br><span class="line">***my web test ***</span><br><span class="line">***my web test ***</span><br></pre></td></tr></table></figure><p>从日志中可以看到已经访问过两次。</p><p>以后开发的步骤：需要掌握Dokcerfile的编写，建议之后的一切都是使用docker镜像来发布运行。</p><h3 id="发布镜像"><a href="#发布镜像" class="headerlink" title="发布镜像"></a>发布镜像</h3><h4 id="发布到DockerHub"><a href="#发布到DockerHub" class="headerlink" title="发布到DockerHub"></a>发布到DockerHub</h4><p>需要在 <a target="_blank" rel="noopener" href="https://hub.docker.com/">hub.docker</a> 注册账号</p><p>需要在本地使用 <code>docker login</code> 命令登录之后才能发布</p><p>查看命令帮助</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker login --help</span><br><span class="line"></span><br><span class="line">Usage:  docker login [OPTIONS] [SERVER]</span><br><span class="line"></span><br><span class="line">Log in to a Docker registry.</span><br><span class="line">If no server is specified, the default is defined by the daemon.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -p, --password string   Password</span><br><span class="line">      --password-stdin    Take the password from stdin</span><br><span class="line">  -u, --username string   Username</span><br></pre></td></tr></table></figure><p>登录docker hub账号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker login -u xxxx</span><br><span class="line"> Password:</span><br><span class="line"> WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line"> Configure a credential helper to remove this warning. See</span><br><span class="line"> https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"> Login Succeeded</span><br></pre></td></tr></table></figure><p>提交镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker push chyris/itomcat</span><br><span class="line">The push refers to repository [docker.io/chyris/itomcat]</span><br><span class="line">An image does not exist locally with the tag: chyris/itomcat</span><br></pre></td></tr></table></figure><p>push镜像出现的问题，需要增加一个tag</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker tag 7f3c9bb3a621 chyris/tomcat:1.0</span><br></pre></td></tr></table></figure><p>然后 <code>docker push</code> 即可；发布的镜像尽量带上版本号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker push chyris/tomcat:1.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>push的时候也是按镜像的层级来提交的</p><h4 id="发布到阿里云"><a href="#发布到阿里云" class="headerlink" title="发布到阿里云"></a>发布到阿里云</h4><p>登录<a target="_blank" rel="noopener" href="https://www.aliyun.com/">阿里云</a>账号，并找到镜像容器服务：首次登录需要创建个人空间和开通一些服务。</p><p>然后创建命名空间和镜像仓库，可以在镜像仓库位置浏览相关操作命令，如下面所示。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1. 登录阿里云Docker Registry</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker login --username=chyris registry.cn-hangzhou.aliyuncs.com</span></span><br><span class="line">用于登录的用户名为阿里云账号全名，密码为开通服务时设置的密码。</span><br><span class="line">您可以在访问凭证页面修改凭证密码。</span><br><span class="line"></span><br><span class="line">2. 从Registry中拉取镜像</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull registry.cn-hangzhou.aliyuncs.com/chyris/repo-test:[镜像版本号]</span></span><br><span class="line"></span><br><span class="line">3. 将镜像推送到Registry</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker login --username=chyris registry.cn-hangzhou.aliyuncs.com</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/chyris/repo-test:[镜像版本号]</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker push registry.cn-hangzhou.aliyuncs.com/chyris/repo-test:[镜像版本号]</span></span><br><span class="line">请根据实际镜像信息替换示例中的[ImageId]和[镜像版本号]参数。</span><br><span class="line"></span><br><span class="line">4. 选择合适的镜像仓库地址</span><br><span class="line">从ECS推送镜像时，可以选择使用镜像仓库内网地址。推送速度将得到提升并且将不会损耗您的公网流量。</span><br><span class="line">如果使用的机器位于VPC网络，要用 registry-vpc.cn-hangzhou.aliyuncs.com 作为Registry的域名登录</span><br><span class="line"></span><br><span class="line">5. 示例</span><br><span class="line">使用&quot;docker tag&quot;命令重命名镜像，并将它通过专有网络地址推送至Registry。</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker tag 37bb9c63c8b2 registry-vpc.cn-hangzhou.aliyuncs.com/acs/agent:0.7-dfb6816</span></span><br><span class="line"></span><br><span class="line">使用 &quot;docker push&quot; 命令将该镜像推送至远程。</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker push registry-vpc.cn-hangzhou.aliyuncs.com/acs/agent:0.7-dfb6816</span></span><br></pre></td></tr></table></figure><p>把自己制作的 tomcat 镜像，上传到阿里云镜像仓库。</p><p>首先终端登录阿里云账号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker login --username=chyris registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure><p>将本地镜像推从到阿里云镜像仓库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost tomcat]$ sudo docker tag 7f3c9bb3a621 registry.cn-hangzhou.aliyuncs.com/chyris/repo-test:1.0</span><br><span class="line">[chyris@localhost tomcat]$ sudo docker images</span><br><span class="line">REPOSITORY                                           TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">itomcat                                              latest    7f3c9bb3a621   6 hours ago     859MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/chyris/repo-test   1.0       7f3c9bb3a621   6 hours ago     859MB</span><br><span class="line"></span><br><span class="line">[chyris@localhost tomcat]$ sudo docker push registry.cn-hangzhou.aliyuncs.com/chyris/repo-test:1.0</span><br><span class="line">The push refers to repository [registry.cn-hangzhou.aliyuncs.com/chyris/repo-test]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/repository.webp" title="This is an repository image"><p>镜像（Image）</p><p>通过运行镜像启动容器。镜像是一个可执行包，包含运行应用程序所需的所有内容 - 代码，运行时，库，环境变量和配置文件。Docker 运行容器前需要本地存在对应的镜像，如果本地不存在该镜像，Docker 会从镜像仓库下载该镜像。</p><p>容器（container）</p><p>容器是镜像像的运行时实例</p><p>仓库（Repository）</p><p>存放镜像的地方，一个容易混淆的概念是注册服务器（Registry ） 。实际上注册服务器是管理仓库的具体服务器，每个服务器上可以有多个仓库，而每个仓库下面有多个镜像。从这方面来说，仓库可以被认为是一个具体的项目或目录。例如对于仓库地址 dl.dockerpool.com&#x2F;ubuntu 来说， dl.dockerpool.com 是注册服务器地址， ubuntu 是仓库名。</p><p>我们来看一个图详细说明一下三者之间的关系</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/repository02.webp" title="This is an repository image"><h2 id="Docker-网络"><a href="#Docker-网络" class="headerlink" title="Docker 网络"></a>Docker 网络</h2><h3 id="理解-docker0"><a href="#理解-docker0" class="headerlink" title="理解 docker0"></a>理解 docker0</h3><p>查看本地虚拟机上 centos 的 ip 地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:d9:d7:9d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">...</span><br><span class="line">5: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:72:38:a9:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>可见虚拟主机上分为三个网络：</p><p>lo：本地回环地址</p><p>ens33&#x2F;eth0: 宿主机内网地址</p><p>docker: docker0 地址</p><p>docker 是如何处理容器网络访问的？容器间又是如何通信？</p><p>启动一个容器，并查看容器内部的网络地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat01 tomcat</span><br><span class="line">4553418f7ac979538fb86a8ff191ec900384f4f4251d54f8fb8a53a1d41d9814</span><br></pre></td></tr></table></figure><p>使用 <code>docker exec</code> 命令，交互模式执行 <code>ip addr</code> 命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 ip addr</span><br><span class="line">OCI runtime exec failed: exec failed: unable to start container process: exec: &quot;ip&quot;: executable file not found in $PATH: unknown</span><br></pre></td></tr></table></figure><p>由于容器内没有这个命令，所以可以通过以下两种方式，都可以查看 ip 地址。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	4553418f7ac9</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker inspect --format=&#x27;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#x27; tomcat01</span><br><span class="line">172.17.0.2</span><br></pre></td></tr></table></figure><p>在 linux 主机 ping 容器内部，查看网络是否可达。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.087 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.055 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.070 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=4 ttl=64 time=0.064 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.17.0.2 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 2999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.055/0.069/0.087/0.011 ms</span><br></pre></td></tr></table></figure><p>可见，在 linux 主机可以 ping 通 docker 容器内部。</p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>每启动一个docker容器，docker就会给docker容器分配一个ip，只要安装了docker，就会有一个网卡docker0（桥接模式，使用的技术是veth-pair技术）</p><p>再次查看 <code>ip addr</code> ，发现多了一个网卡：veth9655ac4@if8。此时 tomcat01 容器处于启动状态。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:d9:d7:9d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.105/24 brd 192.168.0.255 scope global noprefixroute dynamic ens33</span><br><span class="line">       valid_lft 83128sec preferred_lft 83128sec</span><br><span class="line">    inet6 fe80::9150:45b4:293f:2ba5/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br><span class="line">5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:72:38:a9:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:72ff:fe38:a90d/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: veth9655ac4@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 76:fd:f6:75:06:80 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::74fd:f6ff:fe75:680/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>再次启动一个容器，并查看本机网卡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat02 tomcat</span><br><span class="line">cc267cee73d3a5ac3e22f5f0ea49927ef07e2d16a319f783affa996ab835646d</span><br><span class="line">[chyris@localhost ~]$ ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:d9:d7:9d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.105/24 brd 192.168.0.255 scope global noprefixroute dynamic ens33</span><br><span class="line">       valid_lft 82709sec preferred_lft 82709sec</span><br><span class="line">    inet6 fe80::9150:45b4:293f:2ba5/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br><span class="line">5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:72:38:a9:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:72ff:fe38:a90d/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: veth9655ac4@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 76:fd:f6:75:06:80 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::74fd:f6ff:fe75:680/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: veth8c3be0a@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether a6:55:46:84:bb:62 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::a455:46ff:fe84:bb62/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>此时又多了一块网卡：veth8c3be0a@if10</p><p>查看 tomcat02 的ip地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker inspect --format=&#x27;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#x27; tomcat02</span><br><span class="line">172.17.0.3</span><br></pre></td></tr></table></figure><p>此时，一些现象已经产生：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker0: 172.17.0.1</span><br><span class="line">9: veth9655ac4@if8: 172.17.0.2</span><br><span class="line">11: veth8c3be0a@if10: 172.17.0.3</span><br></pre></td></tr></table></figure><p>在容器内执行命令并没有列出网卡信息，其实可以这样解释：</p><p>宿主机网卡：if9: veth9655ac4 连接着容器内部网卡 if8: 172.17.0.2<br>宿主机网卡：if11: veth8c3be0a 连接着容器内部网卡 if10: 172.17.0.3</p><p>而宿主机网卡构成由下面两部分：</p><ul><li>docker虚拟出来的网卡 docker0: 172.17.0.1</li><li>docker虚拟出来的网卡 if9: veth9655ac4 和 if11: veth8c3be0a。</li></ul><p>这种网卡成对出现的技术就是veth-pair技术</p><p>veth-pair 就是一组成对虚拟设备接口，它们都是成对出现，一端连着协议，一端彼此相连。</p><p>正因为有这个特性，evth-pair充当一个桥梁，专门连接各种虚拟网络设备的。</p><p>openstack，Docker容器之间的连接，OVS的连接，都是使用veth-pair技术。</p><p>测试 tomcat01 和 tomcat02 是否可以 ping 通。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 ping 172.17.0.3</span><br></pre></td></tr></table></figure><p>网络之间可以 ping 通</p><p>docker0通过广播或路由表的方式记录和传递信息，以此实现容器网络互通。</p><p>绘制一个网络模型：</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E7%BD%91%E7%BB%9C.jpg" title="This is an docker网络 image"><p>tomcat01和tomcat02是公用的一个路由器，docker0。</p><p>所有的容器不指定网络的情况下，都是docker0路由的，docker会给容器分配一个默认的可用IP。</p><p>Docker 使用的是linux的桥接，宿主机中是一个docker容器的网桥 docker0。</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/docker%E7%BD%91%E7%BB%9C02.jpg" title="This is an docker网络02 image"><p>Docker中的所有的网络接口都是虚拟的。虚拟的转发效率高。（内网传递文件）</p><p>只要容器删除，对应网桥一对虚拟网卡就没了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker rm -f tomcat02</span><br><span class="line">[chyris@localhost ~]$ ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:d9:d7:9d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.105/24 brd 192.168.0.255 scope global noprefixroute dynamic ens33</span><br><span class="line">       valid_lft 77185sec preferred_lft 77185sec</span><br><span class="line">    inet6 fe80::9150:45b4:293f:2ba5/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br><span class="line">5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:72:38:a9:0d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:72ff:fe38:a90d/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: veth9655ac4@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 76:fd:f6:75:06:80 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::74fd:f6ff:fe75:680/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h3 id="link"><a href="#link" class="headerlink" title="--link"></a>--link</h3><p>思考一个场景（高可用）：我们编写了一个微服务，database url&#x3D;ip:，项目不重启，数据库ip换掉了，我们希望可以处理这个问题，可以名字来进行访问容器？</p><p>通过服务名并不能直接ping通</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat02 ping tomcat01</span><br><span class="line">ping: tomcat01: Name or service not known</span><br></pre></td></tr></table></figure><p>通过<code>--link</code>就可以解决网络连接问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat03 --link tomcat02 tomcat</span><br><span class="line">234b586d0ac6241ff1545b6351d6d581cb3b647cb23d94e85c4843332d1077a1</span><br><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat03 ping tomcat02</span><br><span class="line">PING tomcat02 (172.17.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat02 (172.17.0.3): icmp_seq=1 ttl=64 time=0.085 ms</span><br><span class="line">64 bytes from tomcat02 (172.17.0.3): icmp_seq=2 ttl=64 time=0.055 ms</span><br></pre></td></tr></table></figure><p>反向不能ping通</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ docker exec -it tomcat02 ping tomcat03</span><br><span class="line">ping: tomcat03: Name or service not known</span><br></pre></td></tr></table></figure><p>使用 <code>docker network</code> 命令可以查看所有docker网络信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network --help</span><br><span class="line"></span><br><span class="line">Usage:  docker network COMMAND</span><br><span class="line"></span><br><span class="line">Manage networks</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  connect     Connect a container to a network</span><br><span class="line">  create      Create a network</span><br><span class="line">  disconnect  Disconnect a container from a network</span><br><span class="line">  inspect     Display detailed information on one or more networks</span><br><span class="line">  ls          List networks</span><br><span class="line">  prune       Remove all unused networks</span><br><span class="line">  rm          Remove one or more networks</span><br><span class="line"></span><br><span class="line">Run &#x27;docker network COMMAND --help&#x27; for more information on a command.</span><br></pre></td></tr></table></figure><p>下面是所有的NETWORK</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">e2970ecbcc67   bridge    bridge    local</span><br><span class="line">8a649079d776   host      host      local</span><br><span class="line">5f16ce64d68d   none      null      local</span><br></pre></td></tr></table></figure><p>查看 docker0 网卡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker inspect e2970ecbcc67</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;e2970ecbcc67c454e3a593661c195240fc703a7bbd2146&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-10-02T03:30:36.835076647+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: null,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;234b586d0ac6241ff1545b6351dcb23d94e85c4843332d1077a1&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat03&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;de0e3aae64877efdcc8567027af03d79d3e202ac555c28692d50ab&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:04&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.4/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;4553418f7ac979538fb86a8ff194251d54f8fb8a53a1d41d9814&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;8c6fa559d4a6857e3944dd34eed8d23567b82c7c10af309bbca1c6&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;f0ac1d872959a2044d3e231fda6cd41c3aaea4a92d34f7c61048&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat02&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;d49cdb9ea23741e3b0d9b9519713b80619e99cddfde9408e969530&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;</span><br><span class="line">            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span><br><span class="line">            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>默认的”Gateway”就是docker0</p><p>“Containers”中所有容器的虚拟地址就是在容器启动时由docker分配</p><p>查看容器 tomcat03 详细信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker inspect tomcat03</span><br><span class="line">...</span><br><span class="line">&quot;HostConfig&quot;: &#123;</span><br><span class="line">    &quot;Links&quot;: [</span><br><span class="line">        &quot;/tomcat02:/tomcat03/tomcat02&quot;</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&quot;Networks&quot;: &#123;</span><br><span class="line">    &quot;bridge&quot;: &#123;</span><br><span class="line">        &quot;IPAMConfig&quot;: null,</span><br><span class="line">        &quot;Links&quot;: null,</span><br><span class="line">        &quot;Aliases&quot;: null,</span><br><span class="line">        &quot;NetworkID&quot;: &quot;e2970ecbcc67c454e3a593661bb0fd470f486c195240fc703a7bbd2146&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;8104b7d486de0e3aae64877efdcc8567027af03d32ac555c28692d50ab&quot;,</span><br><span class="line">        &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">        &quot;IPAddress&quot;: &quot;172.17.0.4&quot;,</span><br><span class="line">        &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">        &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">        &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">        &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:11:00:04&quot;,</span><br><span class="line">        &quot;DriverOpts&quot;: null</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于指定了 <code>--link</code>，所以连接 tomcat02 容器的操作会通过容器名查到。</p><p>直接查看 tomcat03 内的hosts文件配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat03 cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.3	tomcat02 f0ac1d872959</span><br><span class="line">172.17.0.4	234b586d0ac6</span><br></pre></td></tr></table></figure><p>所有指向 172.17.0.3 的映射在本地都指向了 <code>tomcat02 f0ac1d872959</code>。</p><p><code>--link</code> 本质就是在hosts配置文件中增加了一个地址映射，将真实ip和主机名做一个映射。</p><p>例如tomcat02就没有用 <code>--link</code> 进行绑定，因此无法使用容器名ping通。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat02 cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.3	f0ac1d872959</span><br></pre></td></tr></table></figure><p>当前不建议使用 <code>--link</code>。使用自定义网络，而不是docker0，官方网桥很多功能有局限。docker0问题：不支持容器名连接访问。</p><h3 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h3><p>查看所有docker网络</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">cbfd8d1d8d88   bridge    bridge    local</span><br><span class="line">8a649079d776   host      host      local</span><br><span class="line">5f16ce64d68d   none      null      local</span><br></pre></td></tr></table></figure><p>网络模式</p><p>bridge：桥接 docker（默认，自己创建也使用bridge桥接模式）</p><p>none：不配置网络</p><p>host：和主机共享网络</p><p>container：容器网络连通（用的少，可以让容器之间直接互联，但是局限很大）</p><p>测试</p><p>直接启动的命令 <code>--net bridge</code> （这个就是docker0）；</p><p>启动容器时不写该参数，默认也是带上这个参数的，以下两种启动方式效果一致。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name tomcat01 tomcat</span><br><span class="line">docker run -d -P --name tomcato1 --net bridge tomcat</span><br></pre></td></tr></table></figure><p>docker0特点：默认模式，域名不能访问，–1ink可以打通连接，但不建议使用。</p><p>可以使用自定义网络，让服务在自定义网络中使用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network create --help</span><br><span class="line">...</span><br><span class="line">[chyris@localhost ~]$ sudo docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span><br><span class="line">6ccc9a935666719bba0f0025c6560adc3960ed939abcababffa873234013ad76</span><br><span class="line">[chyris@localhost ~]$ sudo docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">cbfd8d1d8d88   bridge    bridge    local</span><br><span class="line">8a649079d776   host      host      local</span><br><span class="line">6ccc9a935666   mynet      bridge    local</span><br><span class="line">5f16ce64d68d   none      null      local</span><br></pre></td></tr></table></figure><ul><li><code>--driver bridge</code>：桥接</li><li><code>--subnet 192.168.0.0/16</code> 子网：192.168.0.2 - 192.168.255.254</li><li><code>--gateway 192.168.0.1</code> 网关</li></ul><p>我们自己的网络就创建好了</p><blockquote><p>最好换个地址，由于宿主机在桥接模式下分配的网络ip是:192.168.0.105&#x2F;24，可能会产生冲突，导致后面启动docker之后网络出现问题。出现直接使用rm命令删除该子网即可。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network inspect mynet</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;6ccc9a935666719bba0f0025c6560adc3960ed939abcababffa873234013ad76&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-10-02T23:01:07.44427687+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>启动两个容器测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat-net-01 --net mynet tomcat</span><br><span class="line">80d03fe40ca818c0bf6e8805a76f11f5d0e243b2d70a302d35ad52f9cdba8c90</span><br><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat-net-02 --net mynet tomcat</span><br><span class="line">7316043b47519f5c8132258347ec90528cc087e5bfcd58e18d41c4dd4b36f053</span><br></pre></td></tr></table></figure><p>查看自定义网络信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network inspect mynet</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;6ccc9a935666719bba0f0025c6560ad9abcababffa873234013ad76&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-10-02T23:01:07.44427687+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;7316043b47519f5c8132258347ec90528cc087e5bfcd58e18d41c4dd4b36f053&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat-net-02&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;f534c7a8b2c115af21b4641f103a7dc9a7ca39ff5bc43f80daed010&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;80d03fe40ca818c0bf6e8805a76f11f5d0e243b2d70a302d35ad52f9cdba8c90&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat-net-01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;956acd3192c8f3631603127859afd1086d74bee7cb9d2661ce5bc17&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>此时通过自定义的网络给两个容器分配了ip</p><p>再次测试ping连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat-net-01 ping 192.168.0.3</span><br><span class="line">PING 192.168.0.3 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.0.3: icmp_seq=1 ttl=64 time=0.067 ms</span><br><span class="line">64 bytes from 192.168.0.3: icmp_seq=2 ttl=64 time=0.056 ms</span><br></pre></td></tr></table></figure><p>现在不使用 <code>--link</code> 也可以直接ping名字</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat-net-01 ping tomcat-net-02</span><br><span class="line">PING tomcat-net-02 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.067 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.056 ms</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat-net-02 ping tomcat-net-01</span><br><span class="line">PING tomcat-net-01 (192.168.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.050 ms</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.056 ms</span><br></pre></td></tr></table></figure><p>查看hosts文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat-net-01 cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">192.168.0.2	80d03fe40ca8</span><br></pre></td></tr></table></figure><p>使用自定义网络，修复了docker0的缺点，功能更加完善，推荐使用。</p><p>好处：</p><p>redis、mysql集群 -不同的集群使用不同的网络，保证集群是安全和健康的</p><h3 id="网络连通"><a href="#网络连通" class="headerlink" title="网络连通"></a>网络连通</h3><p>首先需要在docker0新开启两个容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat01 tomcat</span><br><span class="line">015dd88f42fbe60296982b9f7aa311bee085893348d609df3f078ef629206d27</span><br><span class="line">[chyris@localhost ~]$ sudo docker run -d -P --name tomcat02 tomcat</span><br><span class="line">952566eee6c5ca1b6d8647d53a72dd6f468f17b3f09e59ffbd1821ca286c2717</span><br><span class="line"></span><br><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED          STATUS          PORTS                                         NAMES</span><br><span class="line">952566eee6c5   tomcat    &quot;catalina.sh run&quot;   9 seconds ago    Up 7 seconds    0.0.0.0:49156-&gt;8080/tcp, :::49156-&gt;8080/tcp   tomcat02</span><br><span class="line">015dd88f42fb   tomcat    &quot;catalina.sh run&quot;   16 seconds ago   Up 14 seconds   0.0.0.0:49155-&gt;8080/tcp, :::49155-&gt;8080/tcp   tomcat01</span><br><span class="line">7316043b4751   tomcat    &quot;catalina.sh run&quot;   3 hours ago      Up 3 hours      0.0.0.0:49154-&gt;8080/tcp, :::49154-&gt;8080/tcp   tomcat-net-02</span><br><span class="line">80d03fe40ca8   tomcat    &quot;catalina.sh run&quot;   3 hours ago      Up 3 hours      0.0.0.0:49153-&gt;8080/tcp, :::49153-&gt;8080/tcp   tomcat-net-01</span><br><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 ping tomcat-net-01</span><br></pre></td></tr></table></figure><p>tomcat01在docker0网络下，tomcat-net-01在mynet网络下；</p><p>tomcat01 ping tomcat-net-01是ping不通的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 ping tomcat-net-01</span><br><span class="line">ping: tomcat-net-01: Name or service not known</span><br></pre></td></tr></table></figure><p>容器网络和mynet网络需要打通</p><img data-src="/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/inet.jpg" title="This is an mynet image"><p>查看 <code>docker network</code> 命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network --help</span><br><span class="line"></span><br><span class="line">Usage:  docker network COMMAND</span><br><span class="line"></span><br><span class="line">Manage networks</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  connect     Connect a container to a network</span><br><span class="line">  create      Create a network</span><br><span class="line">  disconnect  Disconnect a container from a network</span><br><span class="line">  inspect     Display detailed information on one or more networks</span><br><span class="line">  ls          List networks</span><br><span class="line">  prune       Remove all unused networks</span><br><span class="line">  rm          Remove one or more networks</span><br><span class="line"></span><br><span class="line">Run &#x27;docker network COMMAND --help&#x27; for more information on a command.</span><br></pre></td></tr></table></figure><p>查看 <code>docker network connect</code> 命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network connect --help</span><br><span class="line"></span><br><span class="line">Usage:  docker network connect [OPTIONS] NETWORK CONTAINER</span><br><span class="line"></span><br><span class="line">Connect a container to a network</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --alias strings           Add network-scoped alias for the container</span><br><span class="line">      --driver-opt strings      driver options for the network</span><br><span class="line">      --ip string               IPv4 address (e.g., 172.30.100.104)</span><br><span class="line">      --ip6 string              IPv6 address (e.g., 2001:db8::33)</span><br><span class="line">      --link list               Add link to another container</span><br><span class="line">      --link-local-ip strings   Add a link-local address for the container</span><br></pre></td></tr></table></figure><p>打通tomcat01连接mynet</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network connect mynet tomcat01</span><br><span class="line">[chyris@localhost ~]$ sudo docker network inspect mynet</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;6ccc9a935666719bba0f0025c6560adc3960ed939abcababffa873234013ad76&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-10-02T23:01:07.44427687+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;015dd88f42fbe60296982b9f7aa311bee085893348d609df3f078ef629206d27&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;15f1106eabb93407f54fc2310a719de3a1cbd1b4bb7b7c18088ac2a&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:04&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.4/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;7316043b47519f5c8132258347ec90528cc087e5bfcd58e18d41c4dd4b36f053&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat-net-02&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;f534c7a8b2c11531a26a8aa641f103a7dc9a7ca35bc43f80daed010&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;80d03fe40ca818c0bf6e8805a76f11f5d0e243b2d70a302d35ad52f9cdba8c90&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat-net-01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;956acd3192c89cc037f3631603139afd1086d74bee7d2661ce5bc17&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>连通之后就是将tomcat01放到了mynet网络下<br>一个容器两个ip地址：类似于阿里云服务器的公网ip和私网ip</p><p>此时已经可以ping通</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 ping tomcat-net-01</span><br><span class="line">PING tomcat-net-01 (192.168.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.065 ms</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.052 ms</span><br></pre></td></tr></table></figure><p>如果没有ping命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat01 curl tomcat-net-01:8080</span><br></pre></td></tr></table></figure><p>tomcat02 依旧无法连通</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker exec -it tomcat02 ping tomcat-net-01</span><br><span class="line">ping: tomcat-net-01: Name or service not known</span><br></pre></td></tr></table></figure><p>要跨网络操作其它网络内的容器，就需要使用 <code>docker network connect</code> 连通。</p><h2 id="部署Redis集群"><a href="#部署Redis集群" class="headerlink" title="部署Redis集群"></a>部署Redis集群</h2><p>创建一个网卡：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker network create redis --subnet 172.38.0.0/16</span><br><span class="line">[chyris@localhost ~]$ sudo docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">cbfd8d1d8d88   bridge    bridge    local</span><br><span class="line">8a649079d776   host      host      local</span><br><span class="line">6ccc9a935666   mynet      bridge    local</span><br><span class="line">5f16ce64d68d   none      null      local</span><br><span class="line">37cb05532ce1   redis     bridge    local</span><br></pre></td></tr></table></figure><p>通过脚本一次创建6个redis配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /mydata/redis/node-$&#123;port&#125;/conf</span><br><span class="line">touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">cat &lt;&lt; EOF &gt;/mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>执行上述代码之前，需要切换到root用户。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo su root</span><br></pre></td></tr></table></figure><p>执行上述脚本之后，查看创建配置的结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost chyris]# ls /mydata/redis</span><br><span class="line">node-1  node-2  node-3  node-4  node-5  node-6</span><br><span class="line">[root@localhost chyris]# cd /mydata/redis</span><br><span class="line">[root@localhost redis]# ls node-1/conf</span><br><span class="line">redis.conf</span><br><span class="line">[root@localhost redis]# cat node-1/conf/redis.conf </span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.11</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure><p>通过脚本一次启动6个redis容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">docker run -p 637$&#123;port&#125;:6379 -p 1637$&#123;port&#125;:16379 --name redis-$&#123;port&#125; \</span><br><span class="line">-v /mydata/redis/node-$&#123;port&#125;/data:/data \</span><br><span class="line">-v /mydata/redis/node-$&#123;port&#125;/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.1$&#123;port&#125; redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>此时6个容器都已经启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[chyris@localhost ~]$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                                                                                      NAMES</span><br><span class="line">a49448507101   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s…&quot;   6 minutes ago   Up 6 minutes   0.0.0.0:6376-&gt;6379/tcp, :::6376-&gt;6379/tcp, 0.0.0.0:16376-&gt;16379/tcp, :::16376-&gt;16379/tcp   redis-6</span><br><span class="line">78a6fc5ccb0f   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s…&quot;   6 minutes ago   Up 6 minutes   0.0.0.0:6375-&gt;6379/tcp, :::6375-&gt;6379/tcp, 0.0.0.0:16375-&gt;16379/tcp, :::16375-&gt;16379/tcp   redis-5</span><br><span class="line">61ac16c92370   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s…&quot;   6 minutes ago   Up 6 minutes   0.0.0.0:6374-&gt;6379/tcp, :::6374-&gt;6379/tcp, 0.0.0.0:16374-&gt;16379/tcp, :::16374-&gt;16379/tcp   redis-4</span><br><span class="line">4eaabe0042ed   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s…&quot;   6 minutes ago   Up 6 minutes   0.0.0.0:6373-&gt;6379/tcp, :::6373-&gt;6379/tcp, 0.0.0.0:16373-&gt;16379/tcp, :::16373-&gt;16379/tcp   redis-3</span><br><span class="line">5d67e4e0b768   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s…&quot;   6 minutes ago   Up 6 minutes   0.0.0.0:6372-&gt;6379/tcp, :::6372-&gt;6379/tcp, 0.0.0.0:16372-&gt;16379/tcp, :::16372-&gt;16379/tcp   redis-2</span><br><span class="line">92a5af420637   redis:5.0.9-alpine3.11   &quot;docker-entrypoint.s…&quot;   6 minutes ago   Up 6 minutes   0.0.0.0:6371-&gt;6379/tcp, :::6371-&gt;6379/tcp, 0.0.0.0:16371-&gt;16379/tcp, :::16371-&gt;16379/tcp   redis-1</span><br></pre></td></tr></table></figure><p>进入容器查看工作目录信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost chyris]# docker exec -it redis-1 /bin/bash</span><br><span class="line">OCI runtime exec failed: exec failed: unable to start container process: exec: &quot;/bin/bash&quot;: stat /bin/bash: no such file or directory: unknown</span><br><span class="line">[root@localhost chyris]# docker exec -it redis-1 /bin/sh</span><br><span class="line">/data # ls</span><br><span class="line">appendonly.aof  nodes.conf</span><br></pre></td></tr></table></figure><p>配置集群命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span><br></pre></td></tr></table></figure><p>可以看到集群配置完毕</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost chyris]# docker exec -it redis-1 /bin/sh</span><br><span class="line">/data # redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.1</span><br><span class="line">5:6379 172.38.0.16:6379 --cluster-replicas 1</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 172.38.0.15:6379 to 172.38.0.11:6379</span><br><span class="line">Adding replica 172.38.0.16:6379 to 172.38.0.12:6379</span><br><span class="line">Adding replica 172.38.0.14:6379 to 172.38.0.13:6379</span><br><span class="line">M: 2fd5757472fff7d9e82fe29a855158a295d87495 172.38.0.11:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: b1351809798014f3a2fe7e7d764d066c9b936918 172.38.0.12:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: ea6482cb8e55f6fd3c68094469565a464a6d53c2 172.38.0.13:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 918c6add9833f51c21e12ee1b813cbf506424029 172.38.0.14:6379</span><br><span class="line">   replicates ea6482cb8e55f6fd3c68094469565a464a6d53c2</span><br><span class="line">S: 6b2c3a34a21e0e6ea5494c2e7479e92378f157b0 172.38.0.15:6379</span><br><span class="line">   replicates 2fd5757472fff7d9e82fe29a855158a295d87495</span><br><span class="line">S: e6d75c41aef55825a20a8b28a7dfbf13754cb9cf 172.38.0.16:6379</span><br><span class="line">   replicates b1351809798014f3a2fe7e7d764d066c9b936918</span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER MEET messages to <span class="built_in">join</span> the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">....</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 172.38.0.11:6379)</span></span><br><span class="line">M: 2fd5757472fff7d9e82fe29a855158a295d87495 172.38.0.11:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: b1351809798014f3a2fe7e7d764d066c9b936918 172.38.0.12:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: e6d75c41aef55825a20a8b28a7dfbf13754cb9cf 172.38.0.16:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates b1351809798014f3a2fe7e7d764d066c9b936918</span><br><span class="line">M: ea6482cb8e55f6fd3c68094469565a464a6d53c2 172.38.0.13:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 6b2c3a34a21e0e6ea5494c2e7479e92378f157b0 172.38.0.15:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 2fd5757472fff7d9e82fe29a855158a295d87495</span><br><span class="line">S: 918c6add9833f51c21e12ee1b813cbf506424029 172.38.0.14:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ea6482cb8e55f6fd3c68094469565a464a6d53c2</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure><p>进入集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/data # redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:7</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:469</span><br><span class="line">cluster_stats_messages_pong_sent:475</span><br><span class="line">cluster_stats_messages_meet_sent:1</span><br><span class="line">cluster_stats_messages_sent:945</span><br><span class="line">cluster_stats_messages_ping_received:469</span><br><span class="line">cluster_stats_messages_pong_received:470</span><br><span class="line">cluster_stats_messages_meet_received:6</span><br><span class="line">cluster_stats_messages_received:945</span><br></pre></td></tr></table></figure><p>redis-cli - client 单机<br>redis-cli -c 集群</p><p>查看集群节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">b1351809798014f3a2fe7e7d764d066c9b936918 172.38.0.12:6379@16379 master - 0 1664750378000 2 connected 5461-10922</span><br><span class="line">e6d75c41aef55825a20a8b28a7dfbf13754cb9cf 172.38.0.16:6379@16379 slave b1351809798014f3a2fe7e7d764d066c9b936918 0 1664750376414 6 connected</span><br><span class="line">ea6482cb8e55f6fd3c68094469565a464a6d53c2 172.38.0.13:6379@16379 master - 0 1664750378432 3 connected 10923-16383</span><br><span class="line">6b2c3a34a21e0e6ea5494c2e7479e92378f157b0 172.38.0.15:6379@16379 slave 2fd5757472fff7d9e82fe29a855158a295d87495 0 1664750376615 5 connected</span><br><span class="line">2fd5757472fff7d9e82fe29a855158a295d87495 172.38.0.11:6379@16379 myself,master - 0 1664750378000 1 connected 0-5460</span><br><span class="line">918c6add9833f51c21e12ee1b813cbf506424029 172.38.0.14:6379@16379 slave ea6482cb8e55f6fd3c68094469565a464a6d53c2 0 1664750378533 4 connected</span><br></pre></td></tr></table></figure><p>此时给集群存入一个值，可见当前存值服务由 172.38.0.13 提供：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set a b</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [15495] located at 172.38.0.13:6379</span></span><br><span class="line">OK</span><br><span class="line">172.38.0.13:6379&gt; get a</span><br><span class="line">&quot;b&quot;</span><br></pre></td></tr></table></figure><p>如果这是将 redis-3 容器停掉，任然可以获取到值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">重开一个终端：</span><br><span class="line">[chyris@localhost ~]$ sudo docker stop redis-3</span><br><span class="line">redis-3</span><br><span class="line"></span><br><span class="line">返回原终端</span><br><span class="line">172.38.0.13:6379&gt; get a</span><br><span class="line">^C</span><br><span class="line">/data # redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; get a</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [15495] located at 172.38.0.14:6379</span></span><br><span class="line">&quot;b&quot;</span><br></pre></td></tr></table></figure><p>maskter主机宕掉之后，可以从从机获取同步数据</p><blockquote><p>之前由于配置集群时出现错误，导致服务数据不能同步，可以通过以下步骤解决：<br>ps -ef | grep redis<br>kill -9 pid 依次关闭所有redis节点进程<br>删除集群相关文件，我的做法是:rm -rf &#x2F;mydata<br>按照集群搭建步骤重新开始</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">172.38.0.14:6379&gt; cluster nodes</span><br><span class="line">918c6add9833f51c21e12ee1b813cbf506424029 172.38.0.14:6379@16379 myself,master - 0 1664751042000 7 connected 10923-16383</span><br><span class="line">6b2c3a34a21e0e6ea5494c2e7479e92378f157b0 172.38.0.15:6379@16379 slave 2fd5757472fff7d9e82fe29a855158a295d87495 0 1664751043113 5 connected</span><br><span class="line">b1351809798014f3a2fe7e7d764d066c9b936918 172.38.0.12:6379@16379 master - 0 1664751043919 2 connected 5461-10922</span><br><span class="line">2fd5757472fff7d9e82fe29a855158a295d87495 172.38.0.11:6379@16379 master - 0 1664751042508 1 connected 0-5460</span><br><span class="line">ea6482cb8e55f6fd3c68094469565a464a6d53c2 172.38.0.13:6379@16379 master,fail - 1664750542299 1664750542098 3 connected</span><br><span class="line">e6d75c41aef55825a20a8b28a7dfbf13754cb9cf 172.38.0.16:6379@16379 slave b1351809798014f3a2fe7e7d764d066c9b936918 0 1664751042911 6 connected</span><br></pre></td></tr></table></figure><p><code>172.38.0.13:6379@16379 master,fail</code>，.13宕掉之后，<code>172.38.0.14:6379@16379 myself,master</code>，.14立刻升为主机。</p><p>docker搭建高可用redis集群完成，使用docker使事情变得简单。</p><h2 id="SpringBoot微服务打包成docker镜像"><a href="#SpringBoot微服务打包成docker镜像" class="headerlink" title="SpringBoot微服务打包成docker镜像"></a>SpringBoot微服务打包成docker镜像</h2><p>1、构建SpringBoot项目</p><p>2、打包运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure><p>3、编写Dockerfile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM java:8</span><br><span class="line">COPY *.jar /app.jar</span><br><span class="line">CMD [&quot;--server.port=8080&quot;]</span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;app.jar&quot;]</span><br></pre></td></tr></table></figure><p>4、构建镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.复制jar和DockerFIle到服务器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.构建镜像</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker build -t 镜像:版本  .</span></span><br></pre></td></tr></table></figure><p>5、发布运行</p><p>使用Docker后，给别人交付一个镜像即可。</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[1]<a target="_blank" rel="noopener" href="http://edu.jb51.net/docker/docker-tutorial.html">菜鸟学堂 docker-tutorial</a><br>[2]<a target="_blank" rel="noopener" href="https://hub.docker.com/">Docker hub</a><br>[3]<a target="_blank" rel="noopener" href="https://www.docker.com/">Docker</a><br>[4]<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1og4y1q7M4/?vd_source=08abc8c179610d71e6a390ddad0b9f56">bilibili.kuangshen</a><br>[5]<a target="_blank" rel="noopener" href="https://www.kuangstudy.com/bbs/1552836707509223426">《狂神说Java》docker教程通俗易懂</a><br>[6]<a target="_blank" rel="noopener" href="https://www.kuangstudy.com/bbs/1568528839721070593#header19">Docker深度学习</a><br>[7]<a target="_blank" rel="noopener" href="http://t.zoukankan.com/hopeofthevillage-p-11534562.html">Redis删除集群以及重新启动集群</a></p></div><footer class="post-footer"><div class="reward-container"><div>Buy me a coffee</div><button>Donate</button><div class="post-reward"><div><img src="/images/wechatpay.jpg" alt="Chyris WeChat Pay"> <span>WeChat Pay</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>Post author: </strong>Chyris</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://chyriso.github.io/2022/09/26/docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/" title="docker安装使用">https://chyriso.github.io/2022/09/26/docker安装使用/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="post-tags"><a href="/tags/docker/" rel="tag"># docker</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/06/19/%E5%85%B3%E4%BA%8E-hexo-helper-live2d-%E4%B8%8E-busuanzi-count-%E5%86%B2%E7%AA%81/" rel="prev" title="关于 hexo-helper-live2d 与 busuanzi-count 冲突"><i class="fa fa-chevron-left"></i> 关于 hexo-helper-live2d 与 busuanzi-count 冲突</a></div><div class="post-nav-item"><a href="/2022/09/27/hexo%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E4%BF%AE%E6%AD%A3/" rel="next" title="hexo插入图片修正">hexo插入图片修正 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="SOHUCS" sid="ca091de384390f79d61fa4bd6a95c233"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Chyris Wei</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>Symbols count total: </span><span title="Symbols count total">107k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>Reading time total &asymp;</span> <span title="Reading time total">1:37</span></span></div><div class="busuanzi-count"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="Total Visitors">Total visitors: <span id="busuanzi_value_site_uv"></span> </span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="Total Views">Total views: <span id="busuanzi_value_site_pv"></span></span></div><span id="timeDate">Loading time...</span><script>var now=new Date;function createtime(){var n=new Date("05/20/2022 13:14:21");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="The site has been running stably for "+dnum+" days "+hnum+" hours "+mnum+" minutes "+snum+" seconds"}setInterval("createtime()",360)</script></div></footer><script size="300" alpha="0.6" zindex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyw68WtzO","appkey":"42dfa022e91ef28fbe954ca800d6a7a7"}</script><script src="/js/third-party/comments/changyan.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"left",width:150,height:300,hOffset:30,vOffset:-15},mobile:{show:!0},react:{opacity:.7},log:!1})</script></body></html>